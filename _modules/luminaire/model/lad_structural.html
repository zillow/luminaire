<!DOCTYPE html> <html lang=en  data-content_root="../../../"> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;700&family=Nunito+Sans:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel=stylesheet > <link rel=stylesheet  href="../../../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../../../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../../../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../../../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#3f51b5"> <script src="../../../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-119269936-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-119269936-5'); </script> <title>luminaire.model.lad_structural &#8212; Luminaire</title> <link rel=stylesheet  href="../../../_static/global.css"> <link rel=stylesheet  href="../../../_static/colors.css"> <link rel=stylesheet  type="text/css" href="../../../_static/pygments.css?v=649a27d8" /> <link rel=stylesheet  type="text/css" href="../../../_static/material.css?v=79c92029" /> <script src="../../../_static/documentation_options.js?v=01f34227"></script> <script src="../../../_static/doctools.js?v=888ff710"></script> <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script> <link rel=index  title=Index  href="../../../genindex.html" /> <link rel=search  title=Search  href="../../../search.html" /> <body dir=ltr data-md-color-primary=custom data-md-color-accent=custom> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#_modules/luminaire/model/lad_structural" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../../../index.html" title=Luminaire  class="md-header-nav__button md-logo"> &nbsp; </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Luminaire</span> <span class=md-header-nav__topic > luminaire.model.lad_structural </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../../../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=""Search"" autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <div class=md-header-nav__source > <a href="https://github.com/zillow/luminaire/" title="Go to repository" class=md-source  data-md-source=github > <div class=md-source__icon > <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width=28  height=28 > <use xlink:href="#__github" width=24  height=24 ></use> </svg> </div> <div class=md-source__repository > Fork me on Github </div> </a> </div> </div> <script src="../../../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../../../"versions.json"", target_loc = "../../../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../../index.html" class=md-tabs__link >Module code</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../../../index.html" title=Luminaire  class="md-nav__button md-logo"> <img src="../../../_static/" alt=" logo" width=48  height=48 > </a> <a href="../../../index.html" title=Luminaire >Luminaire</a> </label> <div class=md-nav__source > <a href="https://github.com/zillow/luminaire/" title="Go to repository" class=md-source  data-md-source=github > <div class=md-source__icon > <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width=28  height=28 > <use xlink:href="#__github" width=24  height=24 ></use> </svg> </div> <div class=md-source__repository > Fork me on Github </div> </a> </div> <ul class=md-nav__list > <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >Tutorial</span></span> <li class=md-nav__item > <a href="../../../tutorial/dataprofiling.html" class=md-nav__link >Data Profiling</a> <li class=md-nav__item > <a href="../../../tutorial/optimization.html" class=md-nav__link >Configuration Optimization</a> <li class=md-nav__item > <a href="../../../tutorial/outlier_batch.html" class=md-nav__link >Outlier Detection</a> <li class=md-nav__item > <a href="../../../tutorial/streaming.html" class=md-nav__link >Anomaly Detection for Streaming data</a> <li class=md-nav__item > <span class="md-nav__link caption"><span class=caption-text >API Reference</span></span> <li class=md-nav__item > <a href="../../../api_reference/batch_models.html" class=md-nav__link >Luminaire Outlier Detection Models: Structural Modeling</a> <li class=md-nav__item > <a href="../../../api_reference/batch_models.html#module-luminaire.model.model_utils" class=md-nav__link >Luminaire Outlier Detection Models: Factoring holidays as exogenous</a> <li class=md-nav__item > <a href="../../../api_reference/batch_models.html#module-luminaire.model.lad_filtering" class=md-nav__link >Luminaire Outlier Detection Models: Kalman Filter</a> <li class=md-nav__item > <a href="../../../api_reference/exploration.html" class=md-nav__link >Data Exploration and Profiling</a> <li class=md-nav__item > <a href="../../../api_reference/optimization.html" class=md-nav__link >Luminaire Configuration Optimization</a> <li class=md-nav__item > <a href="../../../api_reference/streaming.html" class=md-nav__link >Luminaire Streaming Anomaly Detection Models: Window Density Model</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <ul class=md-nav__list  data-md-scrollfix=""> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <h1 id=modules-luminaire-model-lad-structural--page-root >Source code for luminaire.model.lad_structural</h1><div class=highlight ><pre>
<span></span><span class=kn >from</span> <span class=nn >luminaire.model.base_model</span> <span class=kn >import</span> <span class=n >BaseModel</span><span class=p >,</span> <span class=n >BaseModelObject</span><span class=p >,</span> <span class=n >BaseModelHyperParams</span>
<span class=kn >from</span> <span class=nn >luminaire.exploration.data_exploration</span> <span class=kn >import</span> <span class=n >DataExploration</span>
<span class=kn >from</span> <span class=nn >luminaire.model.model_utils</span> <span class=kn >import</span> <span class=n >LADHolidays</span>
<span class=kn >from</span> <span class=nn >typing</span> <span class=kn >import</span> <span class=n >Dict</span><span class=p >,</span> <span class=n >Tuple</span>
<span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>
<span class=kn >import</span> <span class=nn >warnings</span>
<span class=n >warnings</span><span class=o >.</span><span class=n >filterwarnings</span><span class=p >(</span><span class=s1 >'ignore'</span><span class=p >)</span>


<div class=viewcode-block  id=LADStructuralHyperParams >
<a class=viewcode-back  href="../../../api_reference/batch_models.html#luminaire.model.lad_structural.LADStructuralHyperParams">[docs]</a>
<span class=k >class</span> <span class=nc >LADStructuralHyperParams</span><span class=p >(</span><span class=n >BaseModelHyperParams</span><span class=p >):</span>
<span class=w >    </span><span class=sd >"""</span>
<span class=sd >    Exception class for Luminaire structural anomaly detection model.</span>

<span class=sd >    :param bool include_holidays_exog: whether to include holidays as exogenous variables in the regression.</span>
<span class=sd >        Holidays are defined in :class:`~model.model_utils.LADHolidays`</span>
<span class=sd >    :param int p: Order for the AR component of the model.</span>
<span class=sd >    :param int q: Order for the MA component of the model.</span>
<span class=sd >    :param bool is_log_transformed: A flag to specify whether to take a log transform of the input data. If the data</span>
<span class=sd >        contain negatives, is_log_transformed is ignored even though it is set to True.</span>
<span class=sd >    :param int max_ft_freq: The maximum frequency order for the Fourier transformation.</span>
<span class=sd >    """</span>
    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >include_holidays_exog</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
                 <span class=n >p</span><span class=o >=</span><span class=mi >2</span><span class=p >,</span>
                 <span class=n >q</span><span class=o >=</span><span class=mi >2</span><span class=p >,</span>
                 <span class=n >is_log_transformed</span><span class=o >=</span><span class=kc >True</span><span class=p >,</span>
                 <span class=n >max_ft_freq</span><span class=o >=</span><span class=mi >3</span><span class=p >):</span>

        <span class=nb >super</span><span class=p >(</span><span class=n >LADStructuralHyperParams</span><span class=p >,</span> <span class=bp >self</span><span class=p >)</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span>
            <span class=n >model_name</span><span class=o >=</span><span class=s2 >"LADStructuralModel"</span><span class=p >,</span>
            <span class=n >include_holidays_exog</span><span class=o >=</span><span class=n >include_holidays_exog</span><span class=p >,</span>
            <span class=n >p</span><span class=o >=</span><span class=n >p</span><span class=p >,</span>
            <span class=n >q</span><span class=o >=</span><span class=n >q</span><span class=p >,</span>
            <span class=n >is_log_transformed</span><span class=o >=</span><span class=n >is_log_transformed</span><span class=p >,</span>
            <span class=n >max_ft_freq</span><span class=o >=</span><span class=n >max_ft_freq</span><span class=p >,</span>
        <span class=p >)</span></div>



<div class=viewcode-block  id=LADStructuralError >
<a class=viewcode-back  href="../../../api_reference/batch_models.html#luminaire.model.lad_structural.LADStructuralError">[docs]</a>
<span class=k >class</span> <span class=nc >LADStructuralError</span><span class=p >(</span><span class=ne >Exception</span><span class=p >):</span>
<span class=w >    </span><span class=sd >"""</span>
<span class=sd >    Exception class for Luminaire structural anomaly detection model.</span>

<span class=sd >    """</span>
    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >message</span><span class=p >):</span>
        <span class=n >message</span> <span class=o >=</span> <span class=sa >f</span><span class=s1 >'LAD structural failed! Error: </span><span class=si >{</span><span class=n >message</span><span class=si >}</span><span class=s1 >'</span>

        <span class=nb >super</span><span class=p >(</span><span class=n >LADStructuralError</span><span class=p >,</span> <span class=bp >self</span><span class=p >)</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >message</span><span class=p >)</span></div>



<div class=viewcode-block  id=LADStructuralModel >
<a class=viewcode-back  href="../../../api_reference/batch_models.html#luminaire.model.lad_structural.LADStructuralModel">[docs]</a>
<span class=k >class</span> <span class=nc >LADStructuralModel</span><span class=p >(</span><span class=n >BaseModel</span><span class=p >):</span>
<span class=w >    </span><span class=sd >"""</span>
<span class=sd >    A LAD structural time series model.</span>

<span class=sd >    :param dict hyper_params: Hyper parameters for Luminaire structural modeling.</span>
<span class=sd >        See :class:`luminaire.model.lad_structural.LADStructuralHyperParams` for detailed information.</span>
<span class=sd >    :param str freq: The frequency of the time-series. A `Pandas offset`_ such as 'D', 'H', or 'M'. Luminaire currently</span>
<span class=sd >        supports the following pandas frequency types: 'H', 'D', 'W', 'W-SUN', 'W-MON', 'W-TUE', 'W-WED', 'W-THU',</span>
<span class=sd >        'W-FRI', 'W-SAT'.</span>
<span class=sd >    :param int min_ts_length: The minimum required length of the time series for training.</span>
<span class=sd >    :param int max_ts_length: The maximum required length of the time series for training. The input time series will be</span>
<span class=sd >        truncated if the length is greater than this value.</span>
<span class=sd >    :param float min_ts_mean: Minimum average values in the most recent window of the time series. This optional</span>
<span class=sd >        parameter can be used to avoid over-alerting from noisy low volume time series.</span>
<span class=sd >    :param int min_ts_mean_window: Size of the most recent window to calculate min_ts_mean.</span>

<span class=sd >    .. Note :: This class should be used to manually configure the structural model. Exact configuration parameters</span>
<span class=sd >        can be found in `luminaire.model.lad_structural.LADStructuralHyperParams`. Optimal configuration can be</span>
<span class=sd >        obtained by using Luminaire hyperparameter optimization.</span>

<span class=sd >    .. _statsmodels docs: http://www.statsmodels.org/stable/generated/statsmodels.tsa.arima_model.ARIMA.html</span>
<span class=sd >    .. _Pandas offset: https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects</span>

<span class=sd >    &gt;&gt;&gt; hyper = {"include_holidays_exog": 0, "is_log_transformed": 1, "max_ft_freq": 2, "p": 5, "q": 1}</span>
<span class=sd >    lad_struct_model = LADStructuralModel(hyper_params=hyper, freq='D')</span>
<span class=sd >    &gt;&gt;&gt; lad_struct_model</span>
<span class=sd >    &lt;luminaire.model.lad_structural.LADStructuralModel object at 0x103efe320&gt;</span>
<span class=sd >    """</span>

    <span class=n >__version__</span> <span class=o >=</span> <span class=s2 >"2.0"</span>

    <span class=n >_target_metric</span> <span class=o >=</span> <span class=s1 >'raw'</span>
    <span class=n >_imputed_metric</span> <span class=o >=</span> <span class=s1 >'interpolated'</span>
    <span class=n >_sig_level</span> <span class=o >=</span> <span class=mf >0.10</span>
    <span class=n >_sig_level_extreme</span> <span class=o >=</span> <span class=mf >0.001</span>

    <span class=k >def</span> <span class=fm >__init__</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span>
                 <span class=n >hyper_params</span><span class=p >:</span> <span class=n >LADStructuralHyperParams</span><span class=p >()</span><span class=o >.</span><span class=n >params</span> <span class=ow >or</span> <span class=kc >None</span><span class=p >,</span>
                 <span class=n >freq</span><span class=p >,</span>
                 <span class=n >min_ts_length</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >max_ts_length</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >min_ts_mean</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >min_ts_mean_window</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=o >**</span><span class=n >kwargs</span><span class=p >):</span>

        <span class=bp >self</span><span class=o >.</span><span class=n >hyper_params</span> <span class=o >=</span> <span class=n >hyper_params</span>

        <span class=n >max_scoring_length_dict</span> <span class=o >=</span> <span class=p >{</span>
            <span class=s1 >'H'</span><span class=p >:</span> <span class=mi >48</span><span class=p >,</span>
            <span class=s1 >'D'</span><span class=p >:</span> <span class=mi >10</span><span class=p >,</span>
            <span class=s1 >'W'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-SUN'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-MON'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-TUE'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-WED'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-THU'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-FRI'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span> <span class=s1 >'W-SAT'</span><span class=p >:</span> <span class=mi >8</span><span class=p >,</span>
            <span class=s1 >'M'</span><span class=p >:</span> <span class=mi >24</span><span class=p >,</span> <span class=s1 >'MS'</span><span class=p >:</span> <span class=mi >24</span><span class=p >,</span>
        <span class=p >}</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >max_scoring_length</span> <span class=o >=</span> <span class=n >max_scoring_length_dict</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=n >freq</span><span class=p >)</span>

        <span class=n >fit_diagnostic_lag_dict</span> <span class=o >=</span> <span class=p >{</span>
            <span class=s1 >'H'</span><span class=p >:</span> <span class=mi >144</span> <span class=o >*</span> <span class=mi >2</span><span class=p >,</span>
            <span class=s1 >'D'</span><span class=p >:</span> <span class=mi >7</span> <span class=o >*</span> <span class=mi >4</span><span class=p >,</span>
            <span class=s1 >'W'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-SUN'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-MON'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-TUE'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-WED'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-THU'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-FRI'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span> <span class=s1 >'W-SAT'</span><span class=p >:</span> <span class=mi >12</span><span class=p >,</span>
            <span class=s1 >'M'</span><span class=p >:</span> <span class=mi >24</span><span class=p >,</span> <span class=s1 >'MS'</span><span class=p >:</span> <span class=mi >24</span><span class=p >,</span>
        <span class=p >}</span>
        <span class=bp >self</span><span class=o >.</span><span class=n >_fit_diagnostic_lag</span> <span class=o >=</span> <span class=n >fit_diagnostic_lag_dict</span><span class=o >.</span><span class=n >get</span><span class=p >(</span><span class=n >freq</span><span class=p >)</span>

        <span class=nb >super</span><span class=p >(</span><span class=n >LADStructuralModel</span><span class=p >,</span> <span class=bp >self</span><span class=p >)</span><span class=o >.</span><span class=fm >__init__</span><span class=p >(</span><span class=n >freq</span><span class=o >=</span><span class=n >freq</span><span class=p >,</span> <span class=n >min_ts_mean</span><span class=o >=</span><span class=n >min_ts_mean</span><span class=p >,</span>
                                                 <span class=n >min_ts_mean_window</span><span class=o >=</span><span class=n >min_ts_mean_window</span><span class=p >,</span>
                                                 <span class=n >min_ts_length</span><span class=o >=</span><span class=n >min_ts_length</span><span class=p >,</span> <span class=n >max_ts_length</span><span class=o >=</span><span class=n >max_ts_length</span><span class=p >,</span>
                                                 <span class=o >**</span><span class=n >hyper_params</span><span class=p >,</span> <span class=o >**</span><span class=n >kwargs</span><span class=p >)</span>

    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >_signals</span><span class=p >(</span><span class=bp >cls</span><span class=p >,</span> <span class=n >idx</span><span class=p >,</span> <span class=n >m</span><span class=p >,</span> <span class=n >n</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function computes the sinusoids given the significant frequencies</span>
<span class=sd >        :param list idx: A list containing the significant frequency indices obtained from the spectral density plot in fourier_extp()</span>
<span class=sd >        :param int m: Specifying the current frequency</span>
<span class=sd >        :param int n: Specifying the length of the time series</span>
<span class=sd >        :return: A numpy array containing the sinusoids corresponding to the significant frequencies</span>
<span class=sd >        """</span>
        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=n >signal</span> <span class=o >=</span> <span class=p >[]</span>

        <span class=c1 ># Generating all the frequencies from a time series of length n</span>
        <span class=n >fs</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >fft</span><span class=o >.</span><span class=n >fftfreq</span><span class=p >(</span><span class=n >n</span><span class=p >)</span>

        <span class=c1 ># Loop through the frequencies in idx</span>
        <span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=n >idx</span><span class=p >:</span>
            <span class=n >freq</span> <span class=o >=</span> <span class=n >fs</span><span class=p >[</span><span class=n >i</span><span class=p >]</span>

            <span class=c1 ># Computing the sinusoids for the ith frequency</span>
            <span class=n >signal</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >cos</span><span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >np</span><span class=o >.</span><span class=n >pi</span> <span class=o >*</span> <span class=n >m</span> <span class=o >*</span> <span class=n >freq</span><span class=p >)</span> <span class=o >+</span> <span class=nb >complex</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=n >np</span><span class=o >.</span><span class=n >sin</span><span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >np</span><span class=o >.</span><span class=n >pi</span> <span class=o >*</span> <span class=n >m</span> <span class=o >*</span> <span class=n >freq</span><span class=p >)))</span>
        <span class=k >return</span> <span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >(</span><span class=n >signal</span><span class=p >)</span>

    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >_inv_fft</span><span class=p >(</span><span class=bp >cls</span><span class=p >,</span> <span class=n >n_extp</span><span class=p >,</span> <span class=n >n</span><span class=p >,</span> <span class=n >idx</span><span class=p >,</span> <span class=n >a</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function computes the inverse Fourier transform given the significant frequencies obtained from the spectral</span>
<span class=sd >        density plot in fourier_extp()</span>
<span class=sd >        :param int n_extp: Specifying the length of the time series + the length of the forecast period</span>
<span class=sd >        :param int n: Int specifying the length of the time series</span>
<span class=sd >        :param list idx: A list containing the significant frequency indices obtained from the spectral density plot in fourier_extp()</span>
<span class=sd >        :param list a: A list containing the coefficient of the significant frequencies in the Fourier transform</span>
<span class=sd >        :return: A numpy array containing the inverse transformation from the fourier transformation of the original</span>
<span class=sd >        time series</span>
<span class=sd >        """</span>
        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=n >ts</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=nb >range</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=n >n_extp</span><span class=p >):</span>
            <span class=c1 ># Sinusoid for the ith frequency</span>
            <span class=n >s_array</span> <span class=o >=</span> <span class=bp >cls</span><span class=o >.</span><span class=n >_signals</span><span class=p >(</span><span class=n >idx</span><span class=p >,</span> <span class=n >i</span><span class=p >,</span> <span class=n >n</span><span class=p >)</span>

            <span class=c1 ># Computing the inverse Fouries transformation term for the significant coefficients obtained from the</span>
            <span class=c1 ># spectral density</span>
            <span class=n >ts</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >sum</span><span class=p >(</span><span class=n >a</span> <span class=o >*</span> <span class=n >s_array</span><span class=p >)</span> <span class=o >//</span> <span class=n >n</span><span class=p >)</span>
        <span class=k >return</span> <span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >(</span><span class=n >ts</span><span class=p >)</span>

    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >_fourier_extp</span><span class=p >(</span><span class=bp >cls</span><span class=p >,</span> <span class=n >series</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >max_trun</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >forecast_period</span><span class=o >=</span><span class=kc >None</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function approximates the input time series using a Fourier and an inverse Fourier transformation using</span>
<span class=sd >        incremental</span>
<span class=sd >        frequencies (appending next two frequencies every time)</span>
<span class=sd >        :param list series: A list containing the input time series</span>
<span class=sd >        :param int max_trun: Specifying the maximum allowed frequency to consider for the Fourier approximation</span>
<span class=sd >        :param int forecast_period: Specifying the number of points to extrapolate using the fourier transform</span>
<span class=sd >        :return: A list of list where every column contains the Fourier approximation of the input time series using (2 * column number)</span>
<span class=sd >        many frequencies</span>
<span class=sd >        """</span>
        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=kn >import</span> <span class=nn >copy</span>
        <span class=n >n</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >series</span><span class=p >)</span>

        <span class=n >smoothing_loc</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >where</span><span class=p >((</span><span class=n >series</span> <span class=o >&lt;</span> <span class=n >np</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=n >series</span><span class=p >)</span> <span class=o >-</span> <span class=mi >3</span> <span class=o >*</span> <span class=n >np</span><span class=o >.</span><span class=n >std</span><span class=p >(</span><span class=n >series</span><span class=p >))</span> <span class=o >|</span> <span class=p >(</span><span class=n >series</span> <span class=o >&gt;</span> <span class=n >np</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=n >series</span><span class=p >)</span>
                                                                                    <span class=o >+</span> <span class=mi >3</span> <span class=o >*</span> <span class=n >np</span><span class=o >.</span><span class=n >std</span><span class=p >(</span><span class=n >series</span><span class=p >)))</span>
        <span class=n >smoothed_series</span> <span class=o >=</span> <span class=n >copy</span><span class=o >.</span><span class=n >deepcopy</span><span class=p >(</span><span class=n >series</span><span class=p >)</span>
        <span class=k >if</span> <span class=nb >len</span><span class=p >(</span><span class=n >smoothing_loc</span><span class=p >[</span><span class=mi >0</span><span class=p >])</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
            <span class=k >for</span> <span class=n >idx</span> <span class=ow >in</span> <span class=n >smoothing_loc</span><span class=p >[</span><span class=mi >0</span><span class=p >]:</span>
                <span class=n >smoothed_series</span><span class=p >[</span><span class=n >idx</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=n >smoothed_series</span><span class=p >[</span><span class=nb >max</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=n >idx</span> <span class=o >-</span> <span class=mi >6</span><span class=p >):</span> <span class=nb >max</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=n >idx</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)])</span> <span class=k >if</span> <span class=n >idx</span> <span class=o >&gt;</span> <span class=mi >5</span> \
                    <span class=k >else</span> <span class=n >smoothed_series</span><span class=p >[</span><span class=n >idx</span><span class=p >]</span>

        <span class=n >iyf</span> <span class=o >=</span> <span class=p >[]</span>

        <span class=c1 ># Generating the indices based on odd and event number of terms in the time series</span>
        <span class=k >if</span> <span class=nb >int</span><span class=p >(</span><span class=n >n</span><span class=p >)</span> <span class=o >%</span> <span class=mi >2</span> <span class=o >!=</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >all_idx</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=n >n</span> <span class=o >//</span> <span class=mi >2</span> <span class=o >+</span> <span class=mi >1</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >all_idx</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >1</span><span class=p >,</span> <span class=n >n</span> <span class=o >//</span> <span class=mi >2</span><span class=p >)</span>

        <span class=c1 ># Performing Fourier transformation</span>
        <span class=n >yf</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >fft</span><span class=o >.</span><span class=n >rfft</span><span class=p >(</span><span class=n >smoothed_series</span><span class=p >)</span>

        <span class=c1 ># Spectral density for the fourier transformation (to identify the significant frequencies)</span>
        <span class=n >psd</span> <span class=o >=</span> <span class=nb >abs</span><span class=p >(</span><span class=n >yf</span><span class=p >[</span><span class=n >all_idx</span><span class=p >])</span> <span class=o >**</span> <span class=mi >2</span> <span class=o >+</span> <span class=nb >abs</span><span class=p >(</span><span class=n >yf</span><span class=p >[</span><span class=o >-</span><span class=n >all_idx</span><span class=p >])</span> <span class=o >**</span> <span class=mi >2</span>
        <span class=n >psd_sorted</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >copy</span><span class=p >(</span><span class=n >psd</span><span class=p >)</span>
        <span class=n >psd_sorted</span><span class=p >[::</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span><span class=o >.</span><span class=n >sort</span><span class=p >()</span>

        <span class=n >max_trun</span> <span class=o >=</span> <span class=nb >min</span><span class=p >(</span><span class=n >max_trun</span><span class=p >,</span> <span class=nb >max</span><span class=p >(</span><span class=nb >len</span><span class=p >(</span><span class=n >psd_sorted</span><span class=p >)</span> <span class=o >-</span> <span class=mi >1</span><span class=p >,</span> <span class=mi >0</span><span class=p >))</span>

        <span class=c1 ># Computing inverse Fourier transformation by appending next two significant frequencies up to (2 * max_trun)</span>
        <span class=c1 ># frequencies</span>

        <span class=n >idx</span> <span class=o >=</span> <span class=n >all_idx</span><span class=p >[</span><span class=n >np</span><span class=o >.</span><span class=n >where</span><span class=p >(</span><span class=n >psd</span> <span class=o >&gt;</span> <span class=n >psd_sorted</span><span class=p >[</span><span class=n >max_trun</span><span class=p >])[</span><span class=mi >0</span><span class=p >]]</span>
        <span class=n >idx</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >concatenate</span><span class=p >((</span><span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >([</span><span class=mi >0</span><span class=p >]),</span> <span class=n >idx</span><span class=p >),</span> <span class=n >axis</span><span class=o >=</span><span class=mi >0</span><span class=p >)</span>
        <span class=n >a</span> <span class=o >=</span> <span class=n >yf</span><span class=p >[</span><span class=n >idx</span><span class=p >]</span>

        <span class=c1 ># Storing the inverse Fourier transformations with (2 * trun) many frequencies</span>
        <span class=n >iyf</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=bp >cls</span><span class=o >.</span><span class=n >_inv_fft</span><span class=p >(</span><span class=n >n</span> <span class=o >+</span> <span class=n >forecast_period</span><span class=p >,</span> <span class=n >n</span><span class=p >,</span> <span class=n >idx</span><span class=p >,</span> <span class=n >a</span><span class=p >))</span>

        <span class=k >return</span> <span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >(</span><span class=n >iyf</span><span class=p >)</span>

    <span class=k >def</span> <span class=nf >_seasonal_arima</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >endog</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >exog</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >p</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >d</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >q</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >imodels</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >include_holidays</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                        <span class=n >ift_matrix</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >stepwise_fit</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >optimize</span><span class=o >=</span><span class=kc >None</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function runs the ARIMA model with different Fourier transformations based on different number of</span>
<span class=sd >        frequencies.</span>
<span class=sd >        :param pandas.Dttaframe endog: A pandas dataframe storing the endogenous time series</span>
<span class=sd >        :param pandas.Dttaframe exog: A pandas dataframe storing the exogenous pulses obtained through the Fourier transformation</span>
<span class=sd >        and / or the a binary one hot encoding different US holidays</span>
<span class=sd >        :param int p: A tuple containing the minimum and maximum of the auto-regressive terms to be considered in the model</span>
<span class=sd >        :param int d: A tuple containing the minimum and maximum of the differencing to be considered in the model</span>
<span class=sd >        :param int q: A tuple containing the minimum and maximum of the moving average terms to be considered in the model</span>
<span class=sd >        :param int imodels: The current model run based on the current exogenous obtained through first imodels*2 many most</span>
<span class=sd >        relevant frequencies from the Fourier transform</span>
<span class=sd >        :param bool include_holidays: Whether to consider holidays as exogenous</span>
<span class=sd >        :param list ift_matrix: A list of list All exogenous variables where the ith column is the inverse Fourier</span>
<span class=sd >        transformation of the time series with first i*2 most relevant frequencies</span>
<span class=sd >        :param list stepwise_fit: A list storing different model object</span>
<span class=sd >        :param bool optimize: Flag to identify whether called from hyperparameter optimization</span>
<span class=sd >        :param list x_pred: list storing exogenous variable corresponding to the time point to predict</span>
<span class=sd >        :return:</span>
<span class=sd >        """</span>

        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=kn >import</span> <span class=nn >statsmodels.tsa.arima.model</span> <span class=k >as</span> <span class=nn >arima</span>

        <span class=c1 ># Extract the exogenous variable generated based on (imodels * 2) number of most significant</span>
        <span class=c1 ># frequencies</span>
        <span class=k >if</span> <span class=n >imodels</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >fourier_exog</span> <span class=o >=</span> <span class=n >ift_matrix</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span><span class=o >.</span><span class=n >reshape</span><span class=p >(</span><span class=o >-</span><span class=mi >1</span><span class=p >,</span> <span class=mi >1</span><span class=p >)[:,</span> <span class=mi >0</span><span class=p >]</span><span class=o >.</span><span class=n >reshape</span><span class=p >(</span><span class=o >-</span><span class=mi >1</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span>
            <span class=k >if</span> <span class=ow >not</span> <span class=n >include_holidays</span><span class=p >:</span>
                <span class=n >exog</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >real</span><span class=p >(</span><span class=n >fourier_exog</span><span class=p >)</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >exog</span><span class=p >[</span><span class=s1 >'fourier_feature'</span><span class=p >]</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >float64</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >real</span><span class=p >(</span><span class=n >fourier_exog</span><span class=p >[:,</span> <span class=mi >0</span><span class=p >]))</span>

        <span class=c1 ># This check is required due to a bug in statsmodel arima which inflates the predictions and std error</span>
        <span class=c1 ># for time series containing only 0's. TODO: Can be removed if fixed in a later version of statsmodels</span>
        <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >count_nonzero</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span> <span class=o >==</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >idx_max</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span> <span class=o >//</span> <span class=mi >2</span>
            <span class=n >idx</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >random</span><span class=o >.</span><span class=n >randint</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=n >idx_max</span><span class=p >,</span> <span class=mi >1</span><span class=p >)[</span><span class=mi >0</span><span class=p >])</span>
            <span class=n >endog</span><span class=p >[</span><span class=n >idx</span><span class=p >]</span> <span class=o >=</span> <span class=nb >abs</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >random</span><span class=o >.</span><span class=n >normal</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mf >1e-3</span><span class=p >,</span> <span class=mi >1</span><span class=p >)[</span><span class=mi >0</span><span class=p >])</span>

        <span class=k >try</span><span class=p >:</span>
            <span class=n >stepwise_fit</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >arima</span><span class=o >.</span><span class=n >ARIMA</span><span class=p >(</span><span class=n >endog</span><span class=o >=</span><span class=n >endog</span><span class=p >,</span> <span class=n >exog</span><span class=o >=</span><span class=n >exog</span><span class=p >,</span>
                                            <span class=n >order</span><span class=o >=</span><span class=p >(</span><span class=n >p</span><span class=p >,</span> <span class=n >d</span><span class=p >,</span> <span class=n >q</span><span class=p >))</span><span class=o >.</span><span class=n >fit</span><span class=p >(</span><span class=n >method</span><span class=o >=</span><span class=s1 >'statespace'</span><span class=p >))</span>
        <span class=k >except</span> <span class=ne >Exception</span> <span class=k >as</span> <span class=n >e</span><span class=p >:</span>
            <span class=k >raise</span> <span class=n >LADStructuralError</span><span class=p >(</span><span class=n >message</span><span class=o >=</span><span class=nb >str</span><span class=p >(</span><span class=n >e</span><span class=p >))</span>

        <span class=k >return</span> <span class=mi >0</span>


    <span class=k >def</span> <span class=nf >_fit</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >endog</span><span class=p >,</span> <span class=n >endog_end</span><span class=p >,</span> <span class=n >min_ts_mean</span><span class=p >,</span> <span class=n >min_ts_mean_window</span><span class=p >,</span> <span class=n >include_holidays</span><span class=o >=</span><span class=kc >False</span><span class=p >,</span>
             <span class=n >min_ts_length</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >max_ft_freq</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >exog_data</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >optimize</span><span class=o >=</span><span class=kc >None</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function implements the fourier transformation to model the periodicities and implements ARIMA model with</span>
<span class=sd >        different order of differencing, MA and AR terms to generate the optimal prediction and anomaly detection.</span>
<span class=sd >        :param list endog: A list containing the time series input</span>
<span class=sd >        :param str endog_end: pandas datetime containing the last timestamp of the input time series</span>
<span class=sd >        :param float raw_actual: Containing the actual value of the execution date</span>
<span class=sd >        :param float raw_actual_previous: Containing the actual value of the day before execution date</span>
<span class=sd >        :param float interpolated_actual: Containing the interpolated value of the execution date</span>
<span class=sd >        :param pandas.Dttaframe pred_instance_date: pandas datetime containing the prediction timestamp</span>
<span class=sd >        :param float min_ts_mean: The minimum mean value of the time series required for the model to run. For data that</span>
<span class=sd >        originated as integers (such as counts), the ARIMA model can behave erratically when the numbers are small. When</span>
<span class=sd >        this parameter is set, any time series whose mean value is less than this will automatically result in a model</span>
<span class=sd >        failure, rather than a mostly bogus anomaly.</span>
<span class=sd >        :param int min_ts_mean_window: The number of observations (anchored to the end of the time series) to use when</span>
<span class=sd >        applying the min_ts_mean rule. Default is None, which performs the calculation on the entire time series.</span>
<span class=sd >        :param bool include_holidays: Whether to include holidays as exogenous variables in the regression. Holidays</span>
<span class=sd >        are defined in :class:`~luminaire.model.model_utils.LADsHolidays`</span>
<span class=sd >        :param int min_ts_length: Specifying the minimum required length of the time series for training</span>
<span class=sd >        :param int max_ft_freq: The maximum number of frequencies under consideration for the Fourier transformation.</span>
<span class=sd >        :param bool optimize: Flag to identify whether called from hyperparameter optimization</span>
<span class=sd >        :return: A dictionary containing the anomaly flag, details of the prediction data (timestamp, raw, interpolated)</span>
<span class=sd >        lower and upper bound of the confidence interval, flag whether holidays are included in the model as exogenous</span>
<span class=sd >        """</span>
        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=kn >from</span> <span class=nn >pykalman</span> <span class=kn >import</span> <span class=n >KalmanFilter</span>
        <span class=kn >import</span> <span class=nn >warnings</span>
        <span class=n >warnings</span><span class=o >.</span><span class=n >filterwarnings</span><span class=p >(</span><span class=s1 >'ignore'</span><span class=p >)</span>

        <span class=n >p</span><span class=p >,</span> <span class=n >q</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'p'</span><span class=p >],</span> <span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'q'</span><span class=p >]</span>
        <span class=n >freq</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >]</span>
        <span class=n >pred_len</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >max_scoring_length</span>
        <span class=n >x_matrix_train</span> <span class=o >=</span> <span class=kc >None</span>
        <span class=n >x_matrix_score</span> <span class=o >=</span> <span class=kc >None</span>

        <span class=c1 ># set exogenous (holiday) variables for input data</span>
        <span class=k >if</span> <span class=n >include_holidays</span> <span class=ow >and</span> <span class=nb >len</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span> <span class=o >+</span> <span class=n >pred_len</span> <span class=o >&gt;</span> <span class=mi >385</span><span class=p >:</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >exog_data</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >endog</span><span class=o >.</span><span class=n >index</span><span class=o >.</span><span class=n >min</span><span class=p >():</span><span class=n >endog_end</span><span class=p >]</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >include_holidays</span> <span class=o >=</span> <span class=kc >False</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=kc >None</span>

        <span class=k >if</span> <span class=n >min_ts_length</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=nb >len</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span> <span class=o >&lt;</span> <span class=n >min_ts_length</span><span class=p >:</span>
            <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'TimeSeries length less than minimum length specified'</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >min_ts_mean</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span><span class=p >:</span>
            <span class=k >if</span> <span class=p >(</span><span class=n >min_ts_mean_window</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=n >endog</span><span class=p >[</span><span class=o >-</span><span class=n >min_ts_mean_window</span><span class=p >:]</span><span class=o >.</span><span class=n >fillna</span><span class=p >(</span><span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span> <span class=o >&lt;</span> <span class=n >min_ts_mean</span><span class=p >)</span> <span class=ow >or</span> \
                    <span class=p >(</span><span class=n >min_ts_mean_window</span> <span class=ow >is</span> <span class=kc >None</span> <span class=ow >and</span> <span class=n >endog</span><span class=o >.</span><span class=n >fillna</span><span class=p >(</span><span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >mean</span><span class=p >()</span> <span class=o >&lt;</span> <span class=n >min_ts_mean</span><span class=p >):</span>
                <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'Metric values too small to model.'</span><span class=p >)</span>

        <span class=c1 ># Smoothing the given time series as a pre-processing for modeling seasonalities through Fourier</span>
        <span class=c1 ># transformation</span>
        <span class=n >kf</span> <span class=o >=</span> <span class=n >KalmanFilter</span><span class=p >()</span>
        <span class=n >endog_smoothed</span><span class=p >,</span> <span class=n >filtered_state_covariances</span> <span class=o >=</span> <span class=n >kf</span><span class=o >.</span><span class=n >em</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span><span class=o >.</span><span class=n >smooth</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span>
        <span class=n >endog_smoothed</span> <span class=o >=</span> <span class=n >endog_smoothed</span><span class=p >[:,</span> <span class=mi >0</span><span class=p >]</span>

        <span class=n >endog</span><span class=p >,</span> <span class=n >diff_order</span><span class=p >,</span> <span class=n >actual_previous_per_diff</span> <span class=o >=</span> <span class=n >DataExploration</span><span class=o >.</span><span class=n >_stationarizer</span><span class=p >(</span><span class=n >endog</span><span class=o >=</span><span class=n >pd</span><span class=o >.</span><span class=n >Series</span><span class=p >(</span><span class=n >endog</span><span class=p >),</span>
                                                                                    <span class=n >diff_min</span><span class=o >=</span><span class=mi >0</span><span class=p >,</span>
                                                                                    <span class=n >diff_max</span><span class=o >=</span><span class=mi >1</span><span class=p >,</span>
                                                                                    <span class=n >obs_incl</span><span class=o >=</span><span class=kc >False</span><span class=p >)</span>
        <span class=k >if</span> <span class=n >diff_order</span><span class=p >:</span>
            <span class=n >endog_smoothed</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >diff</span><span class=p >(</span><span class=n >endog_smoothed</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >freq</span> <span class=o >==</span> <span class=s1 >'D'</span><span class=p >:</span>
            <span class=n >complete_cycle</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=nb >len</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span> <span class=o >/</span> <span class=mi >7</span><span class=p >)</span>
            <span class=n >endog</span> <span class=o >=</span> <span class=n >endog</span><span class=p >[</span><span class=o >-</span> <span class=p >(</span><span class=n >complete_cycle</span> <span class=o >*</span> <span class=mi >7</span><span class=p >):]</span>
            <span class=n >endog_smoothed</span> <span class=o >=</span> <span class=n >endog_smoothed</span><span class=p >[</span><span class=o >-</span> <span class=p >(</span><span class=n >complete_cycle</span> <span class=o >*</span> <span class=mi >7</span><span class=p >):]</span>
        <span class=k >elif</span> <span class=n >freq</span> <span class=o >==</span> <span class=s1 >'H'</span><span class=p >:</span>
            <span class=n >complete_cycle</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=nb >len</span><span class=p >(</span><span class=n >endog</span><span class=p >)</span> <span class=o >/</span> <span class=mi >24</span><span class=p >)</span>
            <span class=n >endog</span> <span class=o >=</span> <span class=n >endog</span><span class=p >[</span><span class=o >-</span> <span class=p >(</span><span class=n >complete_cycle</span> <span class=o >*</span> <span class=mi >24</span><span class=p >):]</span>
            <span class=n >endog_smoothed</span> <span class=o >=</span> <span class=n >endog_smoothed</span><span class=p >[</span><span class=o >-</span> <span class=p >(</span><span class=n >complete_cycle</span> <span class=o >*</span> <span class=mi >24</span><span class=p >):]</span>

        <span class=n >exog</span> <span class=o >=</span> <span class=n >exog</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=o >-</span><span class=nb >len</span><span class=p >(</span><span class=n >endog</span><span class=p >):]</span> <span class=k >if</span> <span class=n >exog</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=k >else</span> <span class=kc >None</span>

        <span class=k >if</span> <span class=n >include_holidays</span><span class=p >:</span>
            <span class=n >exog</span> <span class=o >=</span> <span class=n >exog</span><span class=o >.</span><span class=n >loc</span><span class=p >[:,</span> <span class=p >(</span><span class=n >exog</span> <span class=o >!=</span> <span class=mi >0</span><span class=p >)</span><span class=o >.</span><span class=n >any</span><span class=p >(</span><span class=n >axis</span><span class=o >=</span><span class=mi >0</span><span class=p >)]</span>
            <span class=n >ext_training_features</span> <span class=o >=</span> <span class=nb >list</span><span class=p >(</span><span class=n >exog</span><span class=o >.</span><span class=n >columns</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >ext_training_features</span> <span class=o >=</span> <span class=kc >None</span>

        <span class=n >stepwise_fit</span> <span class=o >=</span> <span class=p >[]</span>

        <span class=c1 ># Updating the user specified maximum number of frequencies to consider for the Fourier transformation</span>
        <span class=c1 ># based on the length of the smoothed endogenous variable</span>
        <span class=n >max_ft_freq</span> <span class=o >=</span> <span class=nb >int</span><span class=p >(</span><span class=nb >min</span><span class=p >(</span><span class=n >max_ft_freq</span><span class=p >,</span> <span class=nb >len</span><span class=p >(</span><span class=n >endog_smoothed</span><span class=p >)</span> <span class=o >/</span> <span class=mi >4</span><span class=p >))</span>

        <span class=c1 ># Running the Fourier transformation extrapolating one point ahead in future that is going to be used</span>
        <span class=c1 ># for predicting</span>

        <span class=k >if</span> <span class=n >max_ft_freq</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
            <span class=n >x_matrix</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_fourier_extp</span><span class=p >(</span><span class=n >series</span><span class=o >=</span><span class=n >endog_smoothed</span><span class=p >,</span> <span class=n >max_trun</span><span class=o >=</span><span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >max_ft_freq</span><span class=p >),</span>
                                          <span class=n >forecast_period</span><span class=o >=</span><span class=n >pred_len</span><span class=p >)</span>
            <span class=k >if</span> <span class=ow >not</span> <span class=n >optimize</span> <span class=ow >and</span> <span class=n >np</span><span class=o >.</span><span class=n >all</span><span class=p >(</span><span class=n >x_matrix</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >==</span> <span class=n >x_matrix</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=mi >0</span><span class=p >]):</span>
                <span class=n >x_matrix_train</span> <span class=o >=</span> <span class=kc >None</span>
                <span class=n >x_matrix_score</span> <span class=o >=</span> <span class=kc >None</span>
                <span class=n >max_ft_freq</span> <span class=o >=</span> <span class=mi >0</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >x_matrix_train</span> <span class=o >=</span> <span class=n >x_matrix</span><span class=p >[:,</span> <span class=p >:(</span><span class=n >x_matrix</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >-</span> <span class=n >pred_len</span><span class=p >)]</span>
                <span class=n >x_matrix_score</span> <span class=o >=</span> <span class=n >x_matrix</span><span class=p >[:,</span> <span class=p >(</span><span class=n >x_matrix</span><span class=o >.</span><span class=n >shape</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >-</span> <span class=n >pred_len</span><span class=p >):]</span>


        <span class=bp >self</span><span class=o >.</span><span class=n >_seasonal_arima</span><span class=p >(</span><span class=n >endog</span><span class=o >=</span><span class=n >endog</span><span class=p >,</span> <span class=n >exog</span><span class=o >=</span><span class=n >exog</span><span class=p >,</span> <span class=n >p</span><span class=o >=</span><span class=n >p</span><span class=p >,</span> <span class=n >d</span><span class=o >=</span><span class=mi >0</span><span class=p >,</span> <span class=n >q</span><span class=o >=</span><span class=n >q</span><span class=p >,</span> <span class=n >imodels</span><span class=o >=</span><span class=n >max_ft_freq</span><span class=p >,</span>
                             <span class=n >include_holidays</span><span class=o >=</span><span class=n >include_holidays</span><span class=p >,</span> <span class=n >ift_matrix</span><span class=o >=</span><span class=n >x_matrix_train</span><span class=p >,</span>
                             <span class=n >stepwise_fit</span><span class=o >=</span><span class=n >stepwise_fit</span><span class=p >,</span> <span class=n >optimize</span><span class=o >=</span><span class=n >optimize</span><span class=p >)</span>
        <span class=n >model</span> <span class=o >=</span> <span class=n >stepwise_fit</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span>

        <span class=n >seasonal_feature_scoring</span> <span class=o >=</span> <span class=n >x_matrix_score</span><span class=p >[</span><span class=mi >0</span><span class=p >,</span> <span class=p >:]</span><span class=o >.</span><span class=n >tolist</span><span class=p >()</span> <span class=k >if</span> <span class=ow >not</span> <span class=n >x_matrix_score</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=kc >None</span>

        <span class=n >result</span> <span class=o >=</span> <span class=p >{</span>
            <span class=s1 >'model'</span><span class=p >:</span> <span class=n >model</span><span class=p >,</span>
            <span class=s1 >'diff_order'</span><span class=p >:</span> <span class=n >diff_order</span><span class=p >,</span>
            <span class=s1 >'seasonal_feature_scoring'</span><span class=p >:</span> <span class=n >seasonal_feature_scoring</span><span class=p >,</span>
            <span class=s1 >'ext_training_features'</span><span class=p >:</span> <span class=n >ext_training_features</span><span class=p >,</span>
        <span class=p >}</span>

        <span class=n >p_selected</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >k_ar</span> <span class=k >if</span> <span class=nb >hasattr</span><span class=p >(</span><span class=n >model</span><span class=p >,</span> <span class=s1 >'k_ar'</span><span class=p >)</span> <span class=k >else</span> <span class=mi >0</span>
        <span class=n >d_selected</span> <span class=o >=</span> <span class=n >diff_order</span>
        <span class=n >q_selected</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >k_ma</span> <span class=k >if</span> <span class=nb >hasattr</span><span class=p >(</span><span class=n >model</span><span class=p >,</span> <span class=s1 >'k_ma'</span><span class=p >)</span> <span class=k >else</span> <span class=mi >0</span>
        <span class=n >order</span> <span class=o >=</span> <span class=p >(</span><span class=n >p_selected</span><span class=p >,</span> <span class=n >d_selected</span><span class=p >,</span> <span class=n >q_selected</span><span class=p >)</span>

        <span class=k >return</span> <span class=n >result</span><span class=p >,</span> <span class=n >order</span>

    <span class=k >def</span> <span class=nf >_training</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >data</span><span class=p >,</span> <span class=n >ts_start</span><span class=p >,</span> <span class=n >ts_end</span><span class=p >,</span> <span class=n >min_ts_length</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >min_ts_mean</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >min_ts_mean_window</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                  <span class=n >max_ft_freq</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >include_holidays</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >optimize</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=o >**</span><span class=n >kwargs</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function performs the training for the input time series</span>

<span class=sd >        :param pandas.DataFrame data: Input time series data</span>
<span class=sd >        :param str ts_start: Start of the time series data</span>
<span class=sd >        :param str ts_end: End of the time series data</span>
<span class=sd >        :param int min_ts_length: Minimum required length for the time series data</span>
<span class=sd >        :param float min_ts_mean: Minimum mean value for the time series data for training over a fixed length window</span>
<span class=sd >        (min_ts_mean_window)</span>
<span class=sd >        :param int min_ts_mean_window: Length of the window to check min_ts_mean</span>
<span class=sd >        :param int max_ft_freq: Maximum number of frequency for the Fouries transformation</span>
<span class=sd >        :param bool is_log_transformed: Flag for log transformation</span>
<span class=sd >        :param bool optimize: Flag to identify whether called from hyperparameter optimization</span>
<span class=sd >        :return: Trained model and optimal LAD structural model order (p, d, q)</span>
<span class=sd >        :rtype: tuple[dict, tuple[int]]</span>
<span class=sd >        """</span>
        <span class=kn >from</span> <span class=nn >numpy.linalg</span> <span class=kn >import</span> <span class=n >LinAlgError</span>

        <span class=n >freq</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >]</span>

        <span class=k >try</span><span class=p >:</span>

            <span class=k >if</span> <span class=n >data</span> <span class=ow >is</span> <span class=kc >None</span><span class=p >:</span>
                <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'Not enough data to train due to recent change point'</span><span class=p >)</span>

            <span class=n >endog</span> <span class=o >=</span> <span class=n >data</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >_imputed_metric</span><span class=p >]</span>

            <span class=n >index</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >date_range</span><span class=p >(</span><span class=n >start</span><span class=o >=</span><span class=n >ts_start</span><span class=p >,</span> <span class=n >end</span><span class=o >=</span><span class=n >ts_end</span><span class=p >,</span> <span class=n >freq</span><span class=o >=</span><span class=n >freq</span><span class=p >)</span>  <span class=c1 ># Holidays are always daily.</span>

            <span class=n >de_obj</span> <span class=o >=</span> <span class=n >DataExploration</span><span class=p >()</span>
            <span class=n >exog_data</span> <span class=o >=</span> <span class=n >de_obj</span><span class=o >.</span><span class=n >_get_exog_data</span><span class=p >(</span><span class=n >ts_start</span><span class=p >,</span> <span class=n >ts_end</span><span class=p >,</span> <span class=n >index</span><span class=p >)</span> <span class=k >if</span> <span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span>
                <span class=s1 >'include_holidays_exog'</span><span class=p >]</span> <span class=k >else</span> <span class=kc >None</span>

            <span class=c1 ># always run the model first without holiday exogenous variables</span>
            <span class=n >result</span><span class=p >,</span> <span class=n >order</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_fit</span><span class=p >(</span><span class=n >endog</span><span class=o >=</span><span class=n >endog</span><span class=p >,</span> <span class=n >endog_end</span><span class=o >=</span><span class=n >ts_end</span><span class=p >,</span> <span class=n >min_ts_mean</span><span class=o >=</span><span class=n >min_ts_mean</span><span class=p >,</span>
                                      <span class=n >min_ts_mean_window</span><span class=o >=</span><span class=n >min_ts_mean_window</span><span class=p >,</span> <span class=n >include_holidays</span><span class=o >=</span><span class=n >include_holidays</span><span class=p >,</span>
                                      <span class=n >min_ts_length</span><span class=o >=</span><span class=n >min_ts_length</span><span class=p >,</span> <span class=n >max_ft_freq</span><span class=o >=</span><span class=n >max_ft_freq</span><span class=p >,</span> <span class=n >exog_data</span><span class=o >=</span><span class=n >exog_data</span><span class=p >,</span>
                                      <span class=n >optimize</span><span class=o >=</span><span class=n >optimize</span><span class=p >)</span>

            <span class=n >result</span><span class=p >[</span><span class=s1 >'training_tail'</span><span class=p >]</span> <span class=o >=</span> <span class=n >data</span><span class=o >.</span><span class=n >loc</span><span class=p >[:</span><span class=n >ts_end</span><span class=p >]</span><span class=o >.</span><span class=n >values</span><span class=o >.</span><span class=n >tolist</span><span class=p >()[</span><span class=o >-</span><span class=mi >3</span><span class=p >:]</span>

        <span class=k >except</span><span class=p >(</span><span class=n >LinAlgError</span><span class=p >,</span> <span class=ne >ValueError</span><span class=p >,</span> <span class=n >LADStructuralError</span><span class=p >)</span> <span class=k >as</span> <span class=n >e</span><span class=p >:</span>
            <span class=n >result</span> <span class=o >=</span> <span class=p >{</span><span class=s1 >'ErrorMessage'</span><span class=p >:</span> <span class=nb >str</span><span class=p >(</span><span class=n >e</span><span class=p >)}</span>
            <span class=k >return</span> <span class=n >result</span><span class=p >,</span> <span class=kc >None</span>

        <span class=k >return</span> <span class=n >result</span><span class=p >,</span> <span class=n >order</span>

    <span class=k >def</span> <span class=nf >_validate_model</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >data</span><span class=p >,</span> <span class=n >hyper_params</span><span class=p >,</span> <span class=n >result</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function validates a newly trained model before publishing. This valudation checks for underfit due to</span>
<span class=sd >        misspecification of hyperparameters or nonstationarity.</span>

<span class=sd >        :param pandas.DataFrame data: Input time series data</span>
<span class=sd >        :param dict hyper_params: Hyperparameters for model training</span>
<span class=sd >        :param dict result: Training outputs</span>
<span class=sd >        :return: A validation flag for model to publish. The function returns True when the validation is successful,</span>
<span class=sd >        False otherwise.</span>

<span class=sd >        :rtype: bool</span>
<span class=sd >        """</span>

        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=kn >import</span> <span class=nn >scipy.stats</span> <span class=k >as</span> <span class=nn >st</span>

        <span class=n >levene_alpha</span> <span class=o >=</span> <span class=mf >0.05</span>
        <span class=n >grubb_alpha</span> <span class=o >=</span> <span class=mf >0.001</span>
        <span class=n >f_test_alpha</span> <span class=o >=</span> <span class=mf >0.05</span>
        <span class=n >mwu_alpha</span> <span class=o >=</span> <span class=mf >0.0005</span>
        <span class=n >passed</span> <span class=o >=</span> <span class=kc >True</span>

        <span class=n >model</span> <span class=o >=</span> <span class=n >LADStructuralModel</span><span class=p >(</span><span class=n >hyper_params</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >hyper_params</span><span class=p >,</span> <span class=o >**</span><span class=n >result</span><span class=p >)</span>

        <span class=n >freq</span> <span class=o >=</span> <span class=s2 >"1"</span> <span class=o >+</span> <span class=n >result</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >]</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >any</span><span class=p >(</span><span class=n >char</span><span class=o >.</span><span class=n >isdigit</span><span class=p >()</span> <span class=k >for</span> <span class=n >char</span> <span class=ow >in</span> <span class=n >result</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >])</span> <span class=k >else</span> <span class=n >result</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >]</span>

        <span class=n >baseline</span> <span class=o >=</span> <span class=n >data</span><span class=p >[</span><span class=bp >self</span><span class=o >.</span><span class=n >_imputed_metric</span><span class=p >][</span><span class=o >-</span><span class=bp >self</span><span class=o >.</span><span class=n >max_scoring_length</span><span class=p >:]</span><span class=o >.</span><span class=n >values</span>
        <span class=n >baseline</span> <span class=o >=</span> <span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >exp</span><span class=p >(</span><span class=n >baseline</span><span class=p >)</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >tolist</span><span class=p >()</span> <span class=k >if</span> <span class=n >hyper_params</span><span class=p >[</span><span class=s1 >'is_log_transformed'</span><span class=p >]</span> <span class=k >else</span> <span class=n >baseline</span><span class=o >.</span><span class=n >tolist</span><span class=p >()</span>

        <span class=n >predictions</span> <span class=o >=</span> <span class=p >[]</span>
        <span class=n >pred_date</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >Timestamp</span><span class=p >(</span><span class=n >result</span><span class=p >[</span><span class=s1 >'training_end_date'</span><span class=p >])</span>
        <span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=nb >range</span><span class=p >(</span><span class=nb >len</span><span class=p >(</span><span class=n >baseline</span><span class=p >)):</span>
            <span class=n >pred_date</span> <span class=o >=</span> <span class=n >pred_date</span> <span class=o >+</span> <span class=n >pd</span><span class=o >.</span><span class=n >Timedelta</span><span class=p >(</span><span class=n >freq</span><span class=p >)</span>
            <span class=n >result</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >score</span><span class=p >(</span><span class=n >baseline</span><span class=p >[</span><span class=n >i</span><span class=p >],</span> <span class=n >pred_date</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >result</span><span class=p >[</span><span class=s1 >'Success'</span><span class=p >]:</span>
                <span class=n >predictions</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >result</span><span class=p >[</span><span class=s1 >'Prediction'</span><span class=p >])</span>

        <span class=c1 ># We perform Levene test, Mann-Whitney U test, and Grubb test between the predictions and the baseline</span>
        <span class=c1 ># to understand if the are widely different. The two arrays need to be of the same length in order to</span>
        <span class=c1 ># perform these tests.</span>
        <span class=k >if</span> <span class=nb >len</span><span class=p >(</span><span class=n >predictions</span><span class=p >)</span> <span class=o >==</span> <span class=nb >len</span><span class=p >(</span><span class=n >baseline</span><span class=p >):</span>
            <span class=n >N</span> <span class=o >=</span> <span class=nb >len</span><span class=p >(</span><span class=n >predictions</span><span class=p >)</span>

            <span class=n >pvalue_levene</span> <span class=o >=</span> <span class=n >st</span><span class=o >.</span><span class=n >levene</span><span class=p >(</span><span class=n >predictions</span><span class=p >,</span> <span class=n >baseline</span><span class=p >)[</span><span class=mi >1</span><span class=p >]</span>
            <span class=n >pvalue_levene_diff</span> <span class=o >=</span> <span class=n >st</span><span class=o >.</span><span class=n >levene</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >diff</span><span class=p >(</span><span class=n >predictions</span><span class=p >),</span> <span class=n >np</span><span class=o >.</span><span class=n >diff</span><span class=p >(</span><span class=n >baseline</span><span class=p >))[</span><span class=mi >1</span><span class=p >]</span>
            <span class=n >pvalue_mwu</span> <span class=o >=</span> <span class=n >st</span><span class=o >.</span><span class=n >mannwhitneyu</span><span class=p >(</span><span class=n >predictions</span><span class=p >,</span> <span class=n >baseline</span><span class=p >)[</span><span class=mi >1</span><span class=p >]</span> <span class=k >if</span> <span class=n >predictions</span> <span class=o >!=</span> <span class=n >baseline</span> <span class=k >else</span> <span class=mf >1.0</span>

            <span class=n >grubb_test_stat</span> <span class=o >=</span> <span class=nb >max</span><span class=p >(</span><span class=nb >abs</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >(</span><span class=n >predictions</span><span class=p >)</span> <span class=o >-</span> <span class=n >np</span><span class=o >.</span><span class=n >mean</span><span class=p >(</span><span class=n >predictions</span><span class=p >)))</span> <span class=o >/</span> <span class=n >np</span><span class=o >.</span><span class=n >std</span><span class=p >(</span><span class=n >predictions</span><span class=p >,</span> <span class=n >ddof</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
            <span class=n >t_cutoff</span> <span class=o >=</span> <span class=n >st</span><span class=o >.</span><span class=n >t</span><span class=o >.</span><span class=n >ppf</span><span class=p >((</span><span class=n >grubb_alpha</span> <span class=o >/</span> <span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >N</span><span class=p >)),</span> <span class=n >df</span><span class=o >=</span><span class=n >N</span> <span class=o >-</span> <span class=mi >2</span><span class=p >)</span>
            <span class=n >grubb_test</span> <span class=o >=</span> <span class=n >grubb_test_stat</span> <span class=o >&gt;</span> <span class=p >((</span><span class=n >N</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >/</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >(</span><span class=n >N</span><span class=p >))</span> <span class=o >*</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >((</span><span class=n >t_cutoff</span><span class=o >**</span><span class=mi >2</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >N</span> <span class=o >-</span> <span class=mi >2</span> <span class=o >+</span> <span class=p >(</span><span class=n >t_cutoff</span><span class=o >**</span><span class=mi >2</span><span class=p >)))</span>

            <span class=k >if</span> <span class=n >grubb_test</span><span class=p >:</span>
                <span class=n >passed</span> <span class=o >=</span> <span class=kc >False</span>
            <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >std</span><span class=p >(</span><span class=n >baseline</span><span class=p >,</span> <span class=n >ddof</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span> <span class=o >&gt;</span> <span class=mi >0</span><span class=p >:</span>
                <span class=k >if</span> <span class=p >(</span><span class=ow >not</span> <span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >pvalue_levene</span><span class=p >)</span> <span class=ow >and</span> <span class=ow >not</span> <span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >pvalue_levene_diff</span><span class=p >)</span> <span class=ow >and</span> <span class=ow >not</span> <span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >pvalue_mwu</span><span class=p >))</span> <span class=ow >and</span> \
                        <span class=p >(</span><span class=n >pvalue_levene</span> <span class=o >&lt;</span> <span class=n >levene_alpha</span> <span class=ow >or</span> <span class=n >pvalue_levene_diff</span> <span class=o >&lt;</span> <span class=n >levene_alpha</span><span class=p >):</span>
                    <span class=n >F</span> <span class=o >=</span> <span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >std</span><span class=p >(</span><span class=n >predictions</span><span class=p >,</span> <span class=n >ddof</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span> <span class=o >**</span> <span class=mi >2</span><span class=p >)</span> <span class=o >/</span> <span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >std</span><span class=p >(</span><span class=n >baseline</span><span class=p >,</span> <span class=n >ddof</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span> <span class=o >**</span> <span class=mi >2</span><span class=p >)</span>
                    <span class=n >f_test_pval</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >st</span><span class=o >.</span><span class=n >f</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=n >F</span><span class=p >,</span> <span class=n >N</span> <span class=o >-</span> <span class=mi >1</span><span class=p >,</span> <span class=nb >len</span><span class=p >(</span><span class=n >baseline</span><span class=p >)</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span>
                    <span class=k >if</span> <span class=n >f_test_pval</span> <span class=o >&lt;</span> <span class=n >f_test_alpha</span> <span class=ow >and</span> <span class=n >pvalue_mwu</span> <span class=o >&lt;</span> <span class=n >mwu_alpha</span><span class=p >:</span>
                        <span class=n >passed</span> <span class=o >=</span> <span class=kc >False</span>

        <span class=k >return</span> <span class=n >passed</span>

<div class=viewcode-block  id=LADStructuralModel.train >
<a class=viewcode-back  href="../../../api_reference/batch_models.html#luminaire.model.lad_structural.LADStructuralModel.train">[docs]</a>
    <span class=k >def</span> <span class=nf >train</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >data</span><span class=p >,</span> <span class=n >optimize</span><span class=o >=</span><span class=kc >False</span><span class=p >,</span> <span class=n >validate</span><span class=o >=</span><span class=kc >False</span><span class=p >,</span> <span class=o >**</span><span class=n >kwargs</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function trains a structural LAD model for a given time series.</span>

<span class=sd >        :param pandas.DataFrame data: Input time series data</span>
<span class=sd >        :param bool optimize: Flag to identify whether called from hyperparameter optimization</span>
<span class=sd >        :param bool validate: Flag to identify whether to run model validation after training</span>
<span class=sd >        :return: success flag, the model date and the trained lad structural model object</span>
<span class=sd >        :rtype: tuple[bool, str, LADStructuralModel object]</span>

<span class=sd >        &gt;&gt;&gt; data</span>
<span class=sd >                       raw interpolated</span>
<span class=sd >        2020-01-01  1326.0       1326.0</span>
<span class=sd >        2020-01-02  1552.0       1552.0</span>
<span class=sd >        2020-01-03  1432.0       1432.0</span>
<span class=sd >        2020-01-04  1470.0       1470.0</span>
<span class=sd >        2020-01-05  1565.0       1565.0</span>
<span class=sd >        ...            ...          ...</span>
<span class=sd >        2020-06-03  1934.0       1934.0</span>
<span class=sd >        2020-06-04  1873.0       1873.0</span>
<span class=sd >        2020-06-05  1674.0       1674.0</span>
<span class=sd >        2020-06-06  1747.0       1747.0</span>
<span class=sd >        2020-06-07  1782.0       1782.0</span>
<span class=sd >        &gt;&gt;&gt; hyper = {"include_holidays_exog": 0, "is_log_transformed": 0, "max_ft_freq": 2, "p": 5, "q": 1}</span>
<span class=sd >        &gt;&gt;&gt; de_obj = DataExploration(freq='D', is_log_transformed=0)</span>
<span class=sd >        &gt;&gt;&gt; data, pre_prc = de_obj.profile(data)</span>
<span class=sd >        &gt;&gt;&gt; pre_prc</span>
<span class=sd >        {'success': True, 'trend_change_list': ['2020-04-01 00:00:00'], 'change_point_list': ['2020-03-16 00:00:00'],</span>
<span class=sd >        'is_log_transformed': 0, 'min_ts_mean': None, 'ts_start': '2020-01-01 00:00:00',</span>
<span class=sd >        'ts_end': '2020-06-07 00:00:00'}</span>
<span class=sd >        &gt;&gt;&gt; lad_struct_obj = LADStructuralModel(hyper_params=hyper, freq='D')</span>
<span class=sd >        &gt;&gt;&gt; model = lad_struct_obj.train(data=data, **pre_prc)</span>

<span class=sd >        &gt;&gt;&gt; model</span>
<span class=sd >        (True, '2020-06-07 00:00:00', &lt;luminaire.model.lad_structural.LADStructuralModel object at 0x126edf588&gt;)</span>
<span class=sd >        """</span>

        <span class=n >result</span><span class=p >,</span> <span class=n >order</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_training</span><span class=p >(</span><span class=n >data</span><span class=o >=</span><span class=n >data</span><span class=p >,</span>
                                       <span class=n >min_ts_length</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'min_ts_length'</span><span class=p >],</span>
                                       <span class=n >min_ts_mean_window</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'min_ts_mean_window'</span><span class=p >],</span>
                                       <span class=n >max_ft_freq</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'max_ft_freq'</span><span class=p >],</span>
                                       <span class=n >include_holidays</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'include_holidays_exog'</span><span class=p >],</span>
                                       <span class=n >optimize</span><span class=o >=</span><span class=n >optimize</span><span class=p >,</span>
                                       <span class=o >**</span><span class=n >kwargs</span>
                                       <span class=p >)</span>

        <span class=bp >self</span><span class=o >.</span><span class=n >hyper_params</span><span class=p >[</span><span class=s1 >'is_log_transformed'</span><span class=p >]</span> <span class=o >=</span> <span class=n >kwargs</span><span class=p >[</span><span class=s1 >'is_log_transformed'</span><span class=p >]</span>
        <span class=n >result</span><span class=p >[</span><span class=s1 >'training_end_date'</span><span class=p >]</span> <span class=o >=</span> <span class=n >kwargs</span><span class=p >[</span><span class=s1 >'ts_end'</span><span class=p >]</span>
        <span class=n >result</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >]</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >]</span>

        <span class=n >success</span> <span class=o >=</span> <span class=kc >False</span> <span class=k >if</span> <span class=s1 >'ErrorMessage'</span> <span class=ow >in</span> <span class=n >result</span> <span class=k >else</span> <span class=kc >True</span>

        <span class=c1 ># Model validation step to check underfit due to misspecification of hyperparameters to some other reasons.</span>
        <span class=k >if</span> <span class=n >success</span> <span class=ow >and</span> <span class=n >validate</span> <span class=ow >and</span> <span class=ow >not</span> <span class=n >optimize</span><span class=p >:</span>
            <span class=n >passed</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_validate_model</span><span class=p >(</span><span class=n >data</span><span class=o >=</span><span class=n >data</span><span class=p >,</span> <span class=n >hyper_params</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >hyper_params</span><span class=p >,</span> <span class=n >result</span><span class=o >=</span><span class=n >result</span><span class=p >)</span>
            <span class=k >if</span> <span class=ow >not</span> <span class=n >passed</span><span class=p >:</span>
                <span class=n >success</span> <span class=o >=</span> <span class=kc >False</span>
                <span class=n >result</span><span class=p >[</span><span class=s1 >'ErrorMessage'</span><span class=p >]</span> <span class=o >=</span> <span class=s1 >'Model validation failed! Check any issues with the input data or the hyper-parameters.'</span>

        <span class=k >return</span> <span class=n >success</span><span class=p >,</span> <span class=n >kwargs</span><span class=p >[</span><span class=s1 >'ts_end'</span><span class=p >],</span> <span class=n >LADStructuralModel</span><span class=p >(</span><span class=n >hyper_params</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >hyper_params</span><span class=p >,</span> <span class=o >**</span><span class=n >result</span><span class=p >)</span></div>


    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >_predict</span><span class=p >(</span><span class=bp >cls</span><span class=p >,</span> <span class=n >model</span><span class=p >,</span> <span class=n >is_log_transformed</span><span class=p >,</span>
                 <span class=n >raw_actual</span><span class=p >,</span> <span class=n >interpolated_actual</span><span class=p >,</span>
                 <span class=n >training_end</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >seasonal_feature_scoring</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >pred_date</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >order_of_diff</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >training_tail</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >ext_training_features</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >pred_len</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >freq</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >include_holidays_exog</span><span class=o >=</span><span class=kc >None</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function performs the prediction and anomaly detection for a given prediction date and a time point</span>

<span class=sd >        :param python object model: LAD structural model object</span>
<span class=sd >        :param bool is_log_transformed: Flag for log transformation</span>
<span class=sd >        :param float raw_actual: Observed value of the time point</span>
<span class=sd >        :param float interpolated_actual: interpolated value of the time point</span>
<span class=sd >        :param str training_end: Last time series timestamp</span>
<span class=sd >        :param list seasonal_feature_scoring: Fourier features</span>
<span class=sd >        :param str pred_date: Prediction date</span>
<span class=sd >        :param int order_of_diff: Order of differencing for the nonstationarity property of the given time series</span>
<span class=sd >        :param list training_tail: Padding from latest time series observed values for prediction</span>
<span class=sd >        :param pandas.DataFrame ext_training_features: External exogenous variables</span>
<span class=sd >        :param int pred_len: Length of time the prediction need to be generated for</span>
<span class=sd >        :param str freq: Frequency of the observed time series</span>
<span class=sd >        :param bool include_holidays_exog: Flag to include holidays as exogenous in the model</span>
<span class=sd >        :return: Model result</span>
<span class=sd >        :rtype: dict</span>
<span class=sd >        """</span>

        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
        <span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>
        <span class=kn >import</span> <span class=nn >scipy.stats</span> <span class=k >as</span> <span class=nn >st</span>
        <span class=kn >from</span> <span class=nn >numpy.linalg</span> <span class=kn >import</span> <span class=n >LinAlgError</span>
        <span class=kn >import</span> <span class=nn >math</span>

        <span class=n >alpha</span> <span class=o >=</span> <span class=bp >cls</span><span class=o >.</span><span class=n >_sig_level</span>
        <span class=n >alpha_extreme</span> <span class=o >=</span> <span class=bp >cls</span><span class=o >.</span><span class=n >_sig_level_extreme</span>

        <span class=n >include_holidays_exog</span> <span class=o >=</span> <span class=n >include_holidays_exog</span> <span class=k >if</span> <span class=n >ext_training_features</span> <span class=k >else</span> <span class=mi >0</span>

        <span class=n >index</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >date_range</span><span class=p >(</span><span class=n >start</span><span class=o >=</span><span class=n >training_end</span><span class=p >,</span> <span class=n >end</span><span class=o >=</span><span class=n >pred_date</span><span class=p >,</span> <span class=n >freq</span><span class=o >=</span><span class=n >freq</span><span class=p >)[</span><span class=mi >1</span><span class=p >:]</span>  <span class=c1 ># Holidays are always daily.</span>

        <span class=n >de_obj</span> <span class=o >=</span> <span class=n >DataExploration</span><span class=p >()</span>
        <span class=n >pred_exog</span> <span class=o >=</span> <span class=n >de_obj</span><span class=o >.</span><span class=n >_get_exog_data</span><span class=p >(</span><span class=n >pred_date</span><span class=p >,</span> <span class=n >pred_date</span><span class=p >,</span> <span class=n >index</span><span class=p >)</span> <span class=k >if</span> <span class=n >include_holidays_exog</span> <span class=k >else</span> <span class=kc >None</span>

        <span class=k >if</span> <span class=n >pred_exog</span> <span class=ow >is</span> <span class=ow >not</span> <span class=kc >None</span> <span class=ow >and</span> <span class=nb >set</span><span class=p >(</span><span class=n >pred_exog</span><span class=o >.</span><span class=n >columns</span><span class=o >.</span><span class=n >values</span><span class=p >)</span> <span class=o >!=</span> <span class=nb >set</span><span class=p >(</span><span class=n >ext_training_features</span><span class=p >):</span>
            <span class=n >missing_col_list</span> <span class=o >=</span> <span class=nb >list</span><span class=p >(</span><span class=nb >set</span><span class=p >(</span><span class=n >ext_training_features</span><span class=p >)</span> <span class=o >-</span> <span class=nb >set</span><span class=p >(</span><span class=n >pred_exog</span><span class=o >.</span><span class=n >columns</span><span class=o >.</span><span class=n >values</span><span class=p >))</span>
            <span class=n >common_cols</span> <span class=o >=</span> <span class=nb >list</span><span class=p >(</span><span class=nb >set</span><span class=p >(</span><span class=n >ext_training_features</span><span class=p >)</span><span class=o >.</span><span class=n >intersection</span><span class=p >(</span><span class=nb >set</span><span class=p >(</span><span class=n >pred_exog</span><span class=o >.</span><span class=n >columns</span><span class=o >.</span><span class=n >values</span><span class=p >)))</span>
            <span class=n >temp_df</span> <span class=o >=</span> <span class=n >pred_exog</span><span class=p >[</span><span class=n >common_cols</span><span class=p >]</span>
            <span class=n >missing_feat_df</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >DataFrame</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >zeros</span><span class=p >([</span><span class=nb >len</span><span class=p >(</span><span class=n >pred_exog</span><span class=p >),</span> <span class=nb >len</span><span class=p >(</span><span class=n >missing_col_list</span><span class=p >)]),</span>
                                           <span class=n >columns</span><span class=o >=</span><span class=n >missing_col_list</span><span class=p >,</span> <span class=n >index</span><span class=o >=</span><span class=n >pred_exog</span><span class=o >.</span><span class=n >index</span><span class=o >.</span><span class=n >values</span><span class=p >)</span>
            <span class=n >pred_exog</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >concat</span><span class=p >([</span><span class=n >temp_df</span><span class=p >,</span> <span class=n >missing_feat_df</span><span class=p >],</span> <span class=n >axis</span><span class=o >=</span><span class=mi >1</span><span class=p >)</span>
            <span class=n >pred_exog</span> <span class=o >=</span> <span class=n >pred_exog</span><span class=p >[</span><span class=n >ext_training_features</span><span class=p >]</span>

        <span class=n >freq</span> <span class=o >=</span> <span class=s2 >"1"</span> <span class=o >+</span> <span class=n >freq</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >any</span><span class=p >(</span><span class=n >char</span><span class=o >.</span><span class=n >isdigit</span><span class=p >()</span> <span class=k >for</span> <span class=n >char</span> <span class=ow >in</span> <span class=n >freq</span><span class=p >)</span> <span class=k >else</span> <span class=n >freq</span>

        <span class=n >forecast_ndays</span> <span class=o >=</span> <span class=nb >int</span><span class=p >((</span><span class=n >pred_date</span> <span class=o >-</span> <span class=n >pd</span><span class=o >.</span><span class=n >Timestamp</span><span class=p >(</span><span class=n >training_end</span><span class=p >))</span> <span class=o >/</span> <span class=n >pd</span><span class=o >.</span><span class=n >Timedelta</span><span class=p >(</span><span class=n >freq</span><span class=p >))</span>
        <span class=n >model_freshness</span> <span class=o >=</span> <span class=n >forecast_ndays</span> <span class=o >/</span> <span class=nb >float</span><span class=p >(</span><span class=n >pred_len</span><span class=p >)</span>

        <span class=k >try</span><span class=p >:</span>
            <span class=k >if</span> <span class=n >forecast_ndays</span> <span class=o >&gt;</span> <span class=n >pred_len</span><span class=p >:</span>
                <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'Current trained model object expired'</span><span class=p >)</span>

            <span class=n >float_min</span> <span class=o >=</span> <span class=mf >1e-10</span>

            <span class=c1 ># set exogenous (holiday) variables for input data</span>
            <span class=k >if</span> <span class=n >include_holidays_exog</span><span class=p >:</span>
                <span class=n >pred_exog</span> <span class=o >=</span> <span class=n >pred_exog</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=n >pd</span><span class=o >.</span><span class=n >Timestamp</span><span class=p >(</span><span class=n >training_end</span><span class=p >)</span> <span class=o >+</span> <span class=n >pd</span><span class=o >.</span><span class=n >Timedelta</span><span class=p >(</span><span class=n >freq</span><span class=p >):</span> <span class=n >pred_date</span><span class=p >]</span>
            <span class=k >else</span><span class=p >:</span>
                <span class=n >pred_exog</span> <span class=o >=</span> <span class=kc >None</span>

            <span class=k >if</span> <span class=n >seasonal_feature_scoring</span><span class=p >:</span>
                <span class=k >if</span> <span class=ow >not</span> <span class=n >include_holidays_exog</span><span class=p >:</span>
                    <span class=n >pred_exog</span> <span class=o >=</span> <span class=n >seasonal_feature_scoring</span><span class=p >[:</span><span class=n >forecast_ndays</span><span class=p >]</span>
                <span class=k >else</span><span class=p >:</span>
                    <span class=n >pred_exog</span><span class=p >[</span><span class=s1 >'fourier_feature'</span><span class=p >]</span> <span class=o >=</span> <span class=n >seasonal_feature_scoring</span><span class=p >[:</span><span class=n >forecast_ndays</span><span class=p >]</span>

            <span class=n >forecast</span> <span class=o >=</span> <span class=p >[]</span>
            <span class=n >forecast_obj</span> <span class=o >=</span> <span class=n >model</span><span class=o >.</span><span class=n >get_forecast</span><span class=p >(</span><span class=n >steps</span><span class=o >=</span><span class=n >forecast_ndays</span><span class=p >,</span> <span class=n >alpha</span><span class=o >=</span><span class=n >alpha</span><span class=p >,</span> <span class=n >exog</span><span class=o >=</span><span class=n >pred_exog</span><span class=p >)</span>
            <span class=n >forecast</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >real</span><span class=p >(</span><span class=n >forecast_obj</span><span class=o >.</span><span class=n >predicted_mean</span><span class=p >)</span><span class=o >.</span><span class=n >tolist</span><span class=p >())</span>      <span class=c1 ># adding prediction mean to forecast</span>
            <span class=n >forecast</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >real</span><span class=p >(</span><span class=n >forecast_obj</span><span class=o >.</span><span class=n >se_mean</span><span class=p >)</span><span class=o >.</span><span class=n >tolist</span><span class=p >())</span>         <span class=c1 ># adding prediction standard error to forecast</span>
            <span class=n >forecast</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >real</span><span class=p >(</span><span class=n >forecast_obj</span><span class=o >.</span><span class=n >conf_int</span><span class=p >())</span><span class=o >.</span><span class=n >tolist</span><span class=p >())</span>      <span class=c1 ># adding predictions ci's to forecast</span>
            <span class=n >interpolated_training_data</span> <span class=o >=</span> <span class=nb >list</span><span class=p >(</span><span class=nb >zip</span><span class=p >(</span><span class=o >*</span><span class=n >training_tail</span><span class=p >))[</span><span class=mi >1</span><span class=p >]</span>

            <span class=k >for</span> <span class=n >order</span> <span class=ow >in</span> <span class=nb >list</span><span class=p >(</span><span class=nb >reversed</span><span class=p >(</span><span class=nb >range</span><span class=p >(</span><span class=n >order_of_diff</span><span class=p >))):</span>
                <span class=n >training_data_diff</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >diff</span><span class=p >(</span><span class=n >interpolated_training_data</span><span class=p >,</span>
                                             <span class=n >order</span><span class=p >)</span> <span class=k >if</span> <span class=n >order</span> <span class=o >&gt;</span> <span class=mi >0</span> <span class=k >else</span> <span class=n >interpolated_training_data</span>

                <span class=n >forecast_diff_mean</span> <span class=o >=</span> <span class=p >[</span><span class=n >training_data_diff</span><span class=p >[</span><span class=o >-</span><span class=mi >1</span><span class=p >]]</span>
                <span class=n >forecast_diff_ci</span> <span class=o >=</span> <span class=p >[]</span>

                <span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=nb >range</span><span class=p >(</span><span class=n >forecast_ndays</span><span class=p >):</span>
                    <span class=n >forecast_diff_mean</span><span class=o >.</span><span class=n >append</span><span class=p >(</span><span class=n >forecast_diff_mean</span><span class=p >[</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >+</span> <span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=n >i</span><span class=p >])</span>
                    <span class=n >forecast_diff_ci</span><span class=o >.</span><span class=n >append</span><span class=p >([</span><span class=n >forecast_diff_mean</span><span class=p >[</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >-</span>
                                             <span class=p >(</span><span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=o >.</span><span class=n >ppf</span><span class=p >(</span><span class=mi >1</span> <span class=o >-</span> <span class=p >(</span><span class=n >alpha</span> <span class=o >/</span> <span class=mf >2.0</span><span class=p >))</span> <span class=o >*</span> <span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=n >i</span><span class=p >]),</span>
                                             <span class=n >forecast_diff_mean</span><span class=p >[</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >+</span>
                                             <span class=p >(</span><span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=o >.</span><span class=n >ppf</span><span class=p >(</span><span class=mi >1</span> <span class=o >-</span> <span class=p >(</span><span class=n >alpha</span> <span class=o >/</span> <span class=mf >2.0</span><span class=p >))</span> <span class=o >*</span> <span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=n >i</span><span class=p >])])</span>
                <span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >]</span> <span class=o >=</span> <span class=n >forecast_diff_mean</span><span class=p >[</span><span class=mi >1</span><span class=p >:]</span>
                <span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >]</span> <span class=o >=</span> <span class=n >forecast_diff_ci</span>

            <span class=k >if</span> <span class=n >is_log_transformed</span><span class=p >:</span>
                <span class=n >transformed_back_forecast</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >exp</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >+</span> <span class=p >((</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >**</span> <span class=mi >2</span><span class=p >)</span> <span class=o >/</span> <span class=mf >2.0</span><span class=p >))</span> <span class=o >-</span> <span class=mi >1</span>
                <span class=n >transformed_back_std_err</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >sqrt</span><span class=p >((</span><span class=n >np</span><span class=o >.</span><span class=n >exp</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >**</span> <span class=mi >2</span><span class=p >)</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span> <span class=o >*</span> <span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >exp</span><span class=p >((</span><span class=mi >2</span> <span class=o >*</span> <span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >])</span> <span class=o >+</span>
                                                                                                <span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span>
                                                                                                     <span class=o >-</span><span class=mi >1</span><span class=p >]</span> <span class=o >**</span> <span class=mi >2</span><span class=p >))))</span>
                <span class=n >transformed_back_CILower</span> <span class=o >=</span> <span class=n >transformed_back_forecast</span> <span class=o >-</span> \
                                           <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=o >.</span><span class=n >ppf</span><span class=p >(</span><span class=mi >1</span> <span class=o >-</span> <span class=p >(</span><span class=n >alpha</span> <span class=o >/</span> <span class=mf >2.0</span><span class=p >),</span> <span class=mi >0</span><span class=p >,</span> <span class=n >transformed_back_std_err</span><span class=p >)</span> \
                    <span class=k >if</span> <span class=n >transformed_back_std_err</span> <span class=o >!=</span> <span class=mi >0</span> <span class=k >else</span> <span class=n >transformed_back_forecast</span>
                <span class=n >transformed_back_CIUpper</span> <span class=o >=</span> <span class=n >transformed_back_forecast</span> <span class=o >+</span> \
                                           <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=o >.</span><span class=n >ppf</span><span class=p >(</span><span class=mi >1</span> <span class=o >-</span> <span class=p >(</span><span class=n >alpha</span> <span class=o >/</span> <span class=mf >2.0</span><span class=p >),</span> <span class=mi >0</span><span class=p >,</span> <span class=n >transformed_back_std_err</span><span class=p >)</span> \
                    <span class=k >if</span> <span class=n >transformed_back_std_err</span> <span class=o >!=</span> <span class=mi >0</span> <span class=k >else</span> <span class=n >transformed_back_forecast</span>
                <span class=n >transformed_back_interpolated_actual</span> <span class=o >=</span> <span class=nb >float</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >exp</span><span class=p >(</span><span class=n >interpolated_actual</span><span class=p >)</span> <span class=o >-</span> <span class=mi >1</span><span class=p >)</span>
            <span class=k >if</span> <span class=n >np</span><span class=o >.</span><span class=n >sum</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]))</span> <span class=ow >or</span> <span class=n >np</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]):</span>
                <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'Predicted null value'</span><span class=p >)</span>

            <span class=k >if</span> <span class=n >is_log_transformed</span><span class=p >:</span>
                <span class=n >zscore</span> <span class=o >=</span> <span class=p >(</span><span class=n >transformed_back_interpolated_actual</span> <span class=o >-</span>
                          <span class=n >transformed_back_forecast</span><span class=p >)</span> <span class=o >/</span> <span class=nb >max</span><span class=p >(</span><span class=nb >float</span><span class=p >(</span><span class=n >transformed_back_std_err</span><span class=p >),</span> <span class=n >float_min</span><span class=p >)</span>

                <span class=n >anomaly_probability</span> <span class=o >=</span> <span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=nb >abs</span><span class=p >(</span><span class=n >zscore</span><span class=p >)))</span> <span class=o >-</span> <span class=mi >1</span>
                <span class=k >if</span> <span class=n >math</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >anomaly_probability</span><span class=p >)</span> <span class=ow >or</span> <span class=n >math</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >transformed_back_CILower</span><span class=p >)</span> \
                        <span class=ow >or</span> <span class=n >math</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >transformed_back_CIUpper</span><span class=p >):</span>
                    <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'Either Anomaly probability or CILower or CIUpper is NaN under log transform'</span><span class=p >)</span>
                <span class=n >down_anomaly_probability</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=n >zscore</span><span class=p >)</span>
                <span class=n >up_anomaly_probability</span> <span class=o >=</span> <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=n >zscore</span><span class=p >)</span>

                <span class=n >result</span> <span class=o >=</span> <span class=p >{</span><span class=s1 >'Success'</span><span class=p >:</span> <span class=kc >True</span><span class=p >,</span>
                          <span class=s1 >'IsLogTransformed'</span><span class=p >:</span> <span class=n >is_log_transformed</span><span class=p >,</span>
                          <span class=s1 >'LogTransformedAdjustedActual'</span><span class=p >:</span> <span class=n >interpolated_actual</span><span class=p >,</span>
                          <span class=s1 >'LogTransformedPrediction'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]),</span>
                          <span class=s1 >'LogTransformedStdErr'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]),</span>
                          <span class=s1 >'LogTransformedCILower'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >0</span><span class=p >]),</span>
                          <span class=s1 >'LogTransformedCIUpper'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >1</span><span class=p >]),</span>
                          <span class=s1 >'AdjustedActual'</span><span class=p >:</span> <span class=n >transformed_back_interpolated_actual</span><span class=p >,</span>
                          <span class=s1 >'Prediction'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >transformed_back_forecast</span><span class=p >)</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >transformed_back_forecast</span><span class=p >)</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'StdErr'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >transformed_back_std_err</span><span class=p >)</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >transformed_back_std_err</span><span class=p >)</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'CILower'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >transformed_back_CILower</span><span class=p >)</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >transformed_back_CILower</span><span class=p >)</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'-inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'CIUpper'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >transformed_back_CIUpper</span><span class=p >)</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >transformed_back_CIUpper</span><span class=p >)</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'ConfLevel'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=mf >1.0</span> <span class=o >-</span> <span class=n >alpha</span><span class=p >)</span> <span class=o >*</span> <span class=mi >100</span><span class=p >,</span>
                          <span class=s1 >'ExogenousHolidays'</span><span class=p >:</span> <span class=n >include_holidays_exog</span><span class=p >,</span>
                          <span class=s1 >'IsAnomaly'</span><span class=p >:</span> <span class=nb >bool</span><span class=p >(</span><span class=n >anomaly_probability</span> <span class=o >&gt;</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >alpha</span><span class=p >),</span>
                          <span class=s1 >'IsAnomalyExtreme'</span><span class=p >:</span> <span class=nb >bool</span><span class=p >(</span><span class=n >anomaly_probability</span> <span class=o >&gt;</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >alpha_extreme</span><span class=p >),</span>
                          <span class=s1 >'AnomalyProbability'</span><span class=p >:</span> <span class=mi >1</span> <span class=k >if</span> <span class=n >raw_actual</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=nb >float</span><span class=p >(</span><span class=n >anomaly_probability</span><span class=p >),</span>
                          <span class=s1 >'DownAnomalyProbability'</span><span class=p >:</span> <span class=mi >1</span> <span class=k >if</span> <span class=n >raw_actual</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=nb >float</span><span class=p >(</span><span class=n >down_anomaly_probability</span><span class=p >),</span>
                          <span class=s1 >'UpAnomalyProbability'</span><span class=p >:</span> <span class=mi >1</span> <span class=k >if</span> <span class=n >raw_actual</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=nb >float</span><span class=p >(</span><span class=n >up_anomaly_probability</span><span class=p >),</span>
                          <span class=s1 >'ModelFreshness'</span><span class=p >:</span> <span class=n >model_freshness</span><span class=p >}</span>

            <span class=k >else</span><span class=p >:</span>
                <span class=n >zscore</span> <span class=o >=</span> <span class=p >(</span><span class=n >interpolated_actual</span> <span class=o >-</span> <span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >])</span> <span class=o >/</span> <span class=nb >max</span><span class=p >(</span><span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >]),</span> <span class=n >float_min</span><span class=p >)</span>

                <span class=n >anomaly_probability</span> <span class=o >=</span> <span class=p >(</span><span class=mi >2</span> <span class=o >*</span> <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=nb >abs</span><span class=p >(</span><span class=n >zscore</span><span class=p >)))</span> <span class=o >-</span> <span class=mi >1</span>
                <span class=k >if</span> <span class=n >math</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >anomaly_probability</span><span class=p >)</span> <span class=ow >or</span> <span class=n >math</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >0</span><span class=p >])</span> <span class=ow >or</span> <span class=n >math</span><span class=o >.</span><span class=n >isnan</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >1</span><span class=p >]):</span>
                    <span class=k >raise</span> <span class=ne >ValueError</span><span class=p >(</span><span class=s1 >'Either Anomaly probability or CILower or CIUpper is NaN'</span><span class=p >)</span>

                <span class=n >down_anomaly_probability</span> <span class=o >=</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=n >zscore</span><span class=p >)</span>
                <span class=n >up_anomaly_probability</span> <span class=o >=</span> <span class=n >st</span><span class=o >.</span><span class=n >norm</span><span class=p >(</span><span class=mi >0</span><span class=p >,</span> <span class=mi >1</span><span class=p >)</span><span class=o >.</span><span class=n >cdf</span><span class=p >(</span><span class=n >zscore</span><span class=p >)</span>

                <span class=n >result</span> <span class=o >=</span> <span class=p >{</span><span class=s1 >'Success'</span><span class=p >:</span> <span class=kc >True</span><span class=p >,</span>
                          <span class=s1 >'IsLogTransformed'</span><span class=p >:</span> <span class=n >is_log_transformed</span><span class=p >,</span>
                          <span class=s1 >'AdjustedActual'</span><span class=p >:</span> <span class=n >interpolated_actual</span><span class=p >,</span>
                          <span class=s1 >'Prediction'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >])</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >forecast</span><span class=p >[</span><span class=mi >0</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >])</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'StdErr'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >])</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >forecast</span><span class=p >[</span><span class=mi >1</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >])</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'CILower'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >0</span><span class=p >])</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >0</span><span class=p >])</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'-inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'CIUpper'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >1</span><span class=p >])</span> <span class=k >if</span> <span class=ow >not</span> <span class=nb >float</span><span class=p >(</span>
                              <span class=n >forecast</span><span class=p >[</span><span class=mi >2</span><span class=p >][</span><span class=o >-</span><span class=mi >1</span><span class=p >][</span><span class=mi >1</span><span class=p >])</span> <span class=o >==</span> <span class=nb >float</span><span class=p >(</span><span class=s1 >'inf'</span><span class=p >)</span> <span class=k >else</span> <span class=mf >0.0</span><span class=p >,</span>
                          <span class=s1 >'ConfLevel'</span><span class=p >:</span> <span class=nb >float</span><span class=p >(</span><span class=mf >1.0</span> <span class=o >-</span> <span class=n >alpha</span><span class=p >)</span> <span class=o >*</span> <span class=mi >100</span><span class=p >,</span>
                          <span class=s1 >'ExogenousHolidays'</span><span class=p >:</span> <span class=n >include_holidays_exog</span><span class=p >,</span>
                          <span class=s1 >'IsAnomaly'</span><span class=p >:</span> <span class=nb >bool</span><span class=p >(</span><span class=n >anomaly_probability</span> <span class=o >&gt;</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >alpha</span><span class=p >),</span>
                          <span class=s1 >'IsAnomalyExtreme'</span><span class=p >:</span> <span class=nb >bool</span><span class=p >(</span><span class=n >anomaly_probability</span> <span class=o >&gt;</span> <span class=mi >1</span> <span class=o >-</span> <span class=n >alpha_extreme</span><span class=p >),</span>
                          <span class=s1 >'AnomalyProbability'</span><span class=p >:</span> <span class=mi >1</span> <span class=k >if</span> <span class=n >raw_actual</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=nb >float</span><span class=p >(</span><span class=n >anomaly_probability</span><span class=p >),</span>
                          <span class=s1 >'DownAnomalyProbability'</span><span class=p >:</span> <span class=mi >1</span> <span class=k >if</span> <span class=n >raw_actual</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=nb >float</span><span class=p >(</span><span class=n >down_anomaly_probability</span><span class=p >),</span>
                          <span class=s1 >'UpAnomalyProbability'</span><span class=p >:</span> <span class=mi >1</span> <span class=k >if</span> <span class=n >raw_actual</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=nb >float</span><span class=p >(</span><span class=n >up_anomaly_probability</span><span class=p >),</span>
                          <span class=s1 >'ModelFreshness'</span><span class=p >:</span> <span class=n >model_freshness</span><span class=p >}</span>

        <span class=k >except</span> <span class=p >(</span><span class=n >LinAlgError</span><span class=p >,</span> <span class=ne >ValueError</span><span class=p >,</span> <span class=n >LADStructuralError</span><span class=p >)</span> <span class=k >as</span> <span class=n >e</span><span class=p >:</span>
            <span class=n >result</span> <span class=o >=</span> <span class=p >{</span><span class=s1 >'Success'</span><span class=p >:</span> <span class=kc >False</span><span class=p >,</span>
                      <span class=s1 >'AdjustedActual'</span><span class=p >:</span> <span class=n >interpolated_actual</span><span class=p >,</span>
                      <span class=s1 >'ErrorMessage'</span><span class=p >:</span> <span class=nb >str</span><span class=p >(</span><span class=n >e</span><span class=p >)}</span>

        <span class=k >return</span> <span class=n >result</span>

    <span class=nd >@classmethod</span>
    <span class=k >def</span> <span class=nf >_scoring</span><span class=p >(</span><span class=bp >cls</span><span class=p >,</span> <span class=n >model</span><span class=p >,</span> <span class=n >observed_value</span><span class=p >,</span> <span class=n >pred_date</span><span class=p >,</span> <span class=n >training_end</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >seasonal_feature_scoring</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >is_log_transformed</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >order_of_diff</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >training_tail</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >ext_training_features</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >pred_len</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span> <span class=n >freq</span><span class=o >=</span><span class=kc >None</span><span class=p >,</span>
                 <span class=n >include_holidays_exog</span><span class=o >=</span><span class=kc >None</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function performs scoring using the LAD structural model object</span>

<span class=sd >        :param python object model: LAD structural model object</span>
<span class=sd >        :param float observed_value: Observed time series value</span>
<span class=sd >        :param str pred_date: Prediction date</span>
<span class=sd >        :param str training_end: Last time series timestamp</span>
<span class=sd >        :param list seasonal_feature_scoring: Fourier features</span>
<span class=sd >        :param bool is_log_transformed: Flag for log transformation</span>
<span class=sd >        :param int order_of_diff: Order of differencing for the nonstationarity property of the given time series</span>
<span class=sd >        :param list training_tail: Padding from latest time series observed values for prediction</span>
<span class=sd >        :param pandas.DataFrame ext_training_features: External exogenous variables</span>
<span class=sd >        :param int pred_len: Length of time the prediction need to be generated for</span>
<span class=sd >        :param str freq: Frequency of the observed time series</span>
<span class=sd >        :param bool include_holidays_exog: Flag to include holidays as exogenous in the model</span>
<span class=sd >        :return: Model result</span>
<span class=sd >        :rtype: dict</span>
<span class=sd >        """</span>

        <span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>
        <span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>

        <span class=c1 ># Date to predict</span>
        <span class=n >pred_date</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >Timestamp</span><span class=p >(</span><span class=n >pred_date</span><span class=p >)</span>

        <span class=k >if</span> <span class=n >is_log_transformed</span><span class=p >:</span>
            <span class=n >interpolated_actual</span> <span class=o >=</span> <span class=mi >0</span> <span class=k >if</span> <span class=p >(</span><span class=n >observed_value</span> <span class=ow >is</span> <span class=kc >None</span> <span class=ow >or</span> <span class=n >observed_value</span> <span class=o >&lt;=</span> <span class=mi >0</span><span class=p >)</span> <span class=k >else</span> <span class=n >np</span><span class=o >.</span><span class=n >log</span><span class=p >(</span><span class=n >observed_value</span><span class=o >+</span><span class=mi >1</span><span class=p >)</span>
        <span class=k >else</span><span class=p >:</span>
            <span class=n >interpolated_actual</span> <span class=o >=</span> <span class=mi >0</span> <span class=k >if</span> <span class=n >observed_value</span> <span class=ow >is</span> <span class=kc >None</span> <span class=k >else</span> <span class=n >observed_value</span>

        <span class=n >result</span> <span class=o >=</span> <span class=bp >cls</span><span class=o >.</span><span class=n >_predict</span><span class=p >(</span><span class=n >model</span><span class=o >=</span><span class=n >model</span><span class=p >,</span> <span class=n >is_log_transformed</span><span class=o >=</span><span class=n >is_log_transformed</span><span class=p >,</span>
                              <span class=n >raw_actual</span><span class=o >=</span><span class=n >observed_value</span><span class=p >,</span> <span class=n >interpolated_actual</span><span class=o >=</span><span class=n >interpolated_actual</span><span class=p >,</span>
                              <span class=n >training_end</span><span class=o >=</span><span class=n >training_end</span><span class=p >,</span> <span class=n >seasonal_feature_scoring</span><span class=o >=</span><span class=n >seasonal_feature_scoring</span><span class=p >,</span>
                              <span class=n >pred_date</span><span class=o >=</span><span class=n >pred_date</span><span class=p >,</span> <span class=n >order_of_diff</span><span class=o >=</span><span class=n >order_of_diff</span><span class=p >,</span> <span class=n >training_tail</span><span class=o >=</span><span class=n >training_tail</span><span class=p >,</span>
                              <span class=n >ext_training_features</span><span class=o >=</span><span class=n >ext_training_features</span><span class=p >,</span> <span class=n >pred_len</span><span class=o >=</span><span class=n >pred_len</span><span class=p >,</span>
                              <span class=n >freq</span><span class=o >=</span><span class=n >freq</span><span class=p >,</span> <span class=n >include_holidays_exog</span><span class=o >=</span><span class=n >include_holidays_exog</span><span class=p >)</span>

        <span class=k >return</span> <span class=n >result</span>

<div class=viewcode-block  id=LADStructuralModel.score >
<a class=viewcode-back  href="../../../api_reference/batch_models.html#luminaire.model.lad_structural.LADStructuralModel.score">[docs]</a>
    <span class=k >def</span> <span class=nf >score</span><span class=p >(</span><span class=bp >self</span><span class=p >,</span> <span class=n >observed_value</span><span class=p >,</span> <span class=n >pred_date</span><span class=p >,</span> <span class=o >**</span><span class=n >kwargs</span><span class=p >):</span>
<span class=w >        </span><span class=sd >"""</span>
<span class=sd >        This function scores a value observed at a data date given a trained LAD structural model object.</span>

<span class=sd >        :param float observed_value: Observed time series value on the prediction date.</span>
<span class=sd >        :param str pred_date: Prediction date. Needs to be in yyyy-mm-dd or yyyy-mm-dd hh:mm:ss format.</span>
<span class=sd >        :return: Anomaly flag, anomaly probability, prediction and other related metrics.</span>
<span class=sd >        :rtype: dict</span>

<span class=sd >        &gt;&gt;&gt; model</span>
<span class=sd >        &lt;luminaire.model.lad_structural.LADStructuralModel object at 0x11c1c3550&gt;</span>
<span class=sd >        &gt;&gt;&gt; model._params['training_end_date'] # Last data date for training time series</span>
<span class=sd >        '2020-06-07 00:00:00'</span>

<span class=sd >        &gt;&gt;&gt; model.score(2000 ,'2020-06-08')</span>
<span class=sd >        {'Success': True, 'IsLogTransformed': 0, 'AdjustedActual': 2000, 'Prediction': 1943.20426163425,</span>
<span class=sd >        'StdErr': 93.084646777553, 'CILower': 1785.519523590432, 'CIUpper': 2100.88899967807, 'ConfLevel': 90.0,</span>
<span class=sd >        'ExogenousHolidays': 0, 'IsAnomaly': False, 'IsAnomalyExtreme': False, 'AnomalyProbability': 0.42671448831719605,</span>
<span class=sd >        'DownAnomalyProbability': 0.286642755841402, 'UpAnomalyProbability': 0.713357244158598, 'ModelFreshness': 0.1}</span>
<span class=sd >        &gt;&gt;&gt; model.score(2500 ,'2020-06-09')</span>
<span class=sd >        {'Success': True, 'IsLogTransformed': 0, 'AdjustedActual': 2500, 'Prediction': 2028.989933854948,</span>
<span class=sd >        'StdErr': 93.6623172459385, 'CILower': 1861.009403637476, 'CIUpper': 2186.97046407242, 'ConfLevel': 90.0,</span>
<span class=sd >        'ExogenousHolidays': 0, 'IsAnomaly': True, 'IsAnomalyExtreme': True, 'AnomalyProbability': 0.9999987021695071,</span>
<span class=sd >        'DownAnomalyProbability': 6.489152464261849e-07, 'UpAnomalyProbability': 0.9999993510847536,</span>
<span class=sd >        'ModelFreshness': 0.2}</span>

<span class=sd >        """</span>

        <span class=n >result</span> <span class=o >=</span> <span class=bp >self</span><span class=o >.</span><span class=n >_scoring</span><span class=p >(</span><span class=n >model</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'model'</span><span class=p >],</span> <span class=n >observed_value</span><span class=o >=</span><span class=n >observed_value</span><span class=p >,</span> <span class=n >pred_date</span><span class=o >=</span><span class=n >pred_date</span><span class=p >,</span>
                              <span class=n >training_end</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'training_end_date'</span><span class=p >],</span>
                              <span class=n >seasonal_feature_scoring</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'seasonal_feature_scoring'</span><span class=p >],</span>
                              <span class=n >is_log_transformed</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'is_log_transformed'</span><span class=p >],</span>
                              <span class=n >order_of_diff</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'diff_order'</span><span class=p >],</span>
                              <span class=n >training_tail</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'training_tail'</span><span class=p >],</span>
                              <span class=n >ext_training_features</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'ext_training_features'</span><span class=p >],</span>
                              <span class=n >pred_len</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >max_scoring_length</span><span class=p >,</span> <span class=n >freq</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'freq'</span><span class=p >],</span>
                              <span class=n >include_holidays_exog</span><span class=o >=</span><span class=bp >self</span><span class=o >.</span><span class=n >_params</span><span class=p >[</span><span class=s1 >'include_holidays_exog'</span><span class=p >])</span>

        <span class=k >return</span> <span class=n >result</span></div>
</div>

</pre></div> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2020 Zillow, Inc.. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.2.6. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../../../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>